<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- La etiqueta base hace que todas las rutas relativas se resuelvan desde la misma carpeta -->
  <base href="./">
  <!-- Adaptable a dispositivos móviles -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Desert Gold</title>
  <style>
    /* RESET Y ESTILOS BÁSICOS */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; background-color: #222; color: #eee; line-height: 1.5; }
    #app { max-width: 800px; margin: 0 auto; padding: 1rem; }
    .view { display: none; }
    .active { display: block; }
    h1, h2 { text-align: center; margin-bottom: 1rem; }
    button {
      padding: 0.75rem 1.5rem; margin: 0.5rem; font-size: 1rem;
      border: none; border-radius: 5px; background-color: #555; color: #eee; cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #777; }
    /* CARTAS DE PERSONAJES */
    .character-card {
      display: inline-block; width: 150px; margin: 10px; text-align: center;
      cursor: pointer; border: 1px solid #555; border-radius: 8px;
      overflow: hidden; background-color: #333; transition: transform 0.2s;
    }
    .character-card:hover { transform: scale(1.05); }
    .character-card img { width: 100%; height: auto; }
    .character-card p { margin: 0.5rem; }
    /* VISTAS: MENÚ, SELECCIÓN, RESULTADO */
    #main-menu, #character-selection, #result { text-align: center; padding: 1rem; }
    /* COMBATE */
    #combat { padding: 1rem; }
    /* Scoreboard: muestra el nombre, salud y balas */
    #scoreboard {
      display: flex; justify-content: space-around; margin-bottom: 1rem; font-weight: bold;
    }
    #scoreboard div { text-align: center; }
    /* Información del turno actual */
    #current-turn { text-align: center; margin-bottom: 1rem; }
    #current-turn img {
      max-width: 200px; border: 3px solid #555; border-radius: 50%; margin: 0 auto; display: block;
    }
    #action-buttons { text-align: center; margin: 1rem 0; }
    #combat-result { text-align: center; margin: 0.5rem 0; font-style: italic; }
    /* Predicción para El Xokas */
    #prediction { text-align: center; margin-bottom: 1rem; font-style: italic; color: #ccc; }
    /* Control de volumen */
    #volume-control { text-align: center; margin-top: 1rem; }
    #volume-control label { margin-right: 0.5rem; }
    /* MEDIA QUERIES */
    @media (max-width: 600px) {
      button { font-size: 0.9rem; padding: 0.5rem 1rem; }
      h1 { font-size: 1.75rem; }
      h2 { font-size: 1.25rem; }
    }
    /* MODAL DE PERSONAJE */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background-color: #333; margin: 10% auto; padding: 20px; border: 1px solid #555;
      width: 90%; max-width: 500px; border-radius: 8px; text-align: center; color: #eee;
    }
    .modal-content img { max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 1rem; }
    .modal-buttons { margin-top: 1rem; }
    .modal-buttons button { margin: 0.5rem; }
  </style>
</head>
<body>
  <div id="app">
    <!-- MENÚ PRINCIPAL -->
    <div id="main-menu" class="view active">
      <h1>Desert Gold</h1>
      <h2>El Tabaco</h2>
      <button id="btn-vs-ai">Combate VS IA</button>
      <button id="btn-duel">Duelo de Fumadores</button>
      <!-- Botón para pausar/reanudar la música del menú -->
      <button id="btn-toggle-menu-music">Pausar Música</button>
      <!-- Control de volumen -->
      <div id="volume-control">
        <label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>
    <!-- SELECCIÓN DE PERSONAJES -->
    <div id="character-selection" class="view">
      <h2 id="selection-header">Selecciona tu Fumador</h2>
      <div id="character-list">
        <!-- Las cartas se generan dinámicamente -->
      </div>
      <button id="btn-back-main">Volver al Menú Principal</button>
    </div>
    <!-- PANTALLA DE COMBATE -->
    <div id="combat" class="view">
      <div id="scoreboard">
        <div id="player1-score">
          <span id="player1-name">Jugador 1</span><br>
          Health: <span id="player1-health">3</span><br>
          Balas: <span id="player1-bullets">0</span>
        </div>
        <div id="player2-score">
          <span id="player2-name">Jugador 2</span><br>
          Health: <span id="player2-health">3</span><br>
          Balas: <span id="player2-bullets">0</span>
        </div>
      </div>
      <div id="current-turn">
        <h2 id="turn-header">TURNO DE</h2>
        <img id="current-turn-img" src="" alt="Jugador Actual">
        <p id="current-turn-info"></p>
        <p id="prediction"></p>
      </div>
      <div id="action-buttons">
        <!-- Opciones de acción se generan dinámicamente -->
      </div>
      <div id="combat-result"></div>
    </div>
    <!-- PANTALLA DE RESULTADO -->
    <div id="result" class="view">
      <h2 id="result-message"></h2>
      <button id="btn-return-main">Volver al Menú Principal</button>
    </div>
  </div>
  <!-- MODAL PARA DETALLES DEL PERSONAJE -->
  <div id="character-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-character-name"></h2>
      <img id="modal-character-img" src="" alt="Imagen del personaje">
      <p id="modal-character-desc"></p>
      <div class="modal-buttons">
        <button id="btn-confirm-character">Seleccionar</button>
        <button id="btn-cancel-character">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    /*************************************
     * DATOS Y ESTADO DEL JUEGO
     *************************************/
    // Todas las imágenes y archivos de audio están en la misma carpeta que index.html
    const characters = {
      "Pepe": { 
        image: "pepe.png", 
        initialBullets: 2, 
        description: "Equilibrado y sencillo, sin mecánicas especiales." 
      },
      "Manueh": { 
        image: "manueh.png", 
        initialBullets: 3, 
        description: "Tiene más balas pero no puede defender; ideal para ataques directos." 
      },
      "Kurt Cobain": { 
        image: "kurtcobain.png", 
        initialBullets: 4, 
        suicideChance: 0.25,  
        description: "Tiene más balas y cada disparo aumenta su probabilidad de suicidio en un 25%." 
      },
      "El Xokas": { 
        image: "xokas.png", 
        initialBullets: 1, 
        predictChance: 0.75, 
        description: "Tiene un 75% de probabilidad de predecir la acción del oponente. Si adivina, se muestra en pantalla el movimiento que realizará el oponente." 
      },
      "Rajoy": { 
        image: "rajoy.png", 
        initialBullets: 1, 
        description: "Resistente, con capacidad para defender varias veces, pero con pocas balas." 
      },
      "Amongolito": { 
        image: "amongolito.png", 
        initialBullets: 2, 
        description: "No puede suicidarse y tiene una mecánica especial impredecible." 
      }
    };

    let gameMode = "";      
    let currentPlayer = 1;  
    let player1Character = "";
    let player2Character = "";
    let turnActions = { 1: null, 2: null };
    let gameOver = false;

    let iaExperience = 0;
    let botDefensiveBias = 0;

    const initialHealth = 3;

    let player1 = null;
    let player2 = null;

    let difficulty = "medium";

    /*************************************
     * CONTROL DE MÚSICA DE FONDO
     *************************************/
    const bgMusic = new Audio();
    bgMusic.loop = true;
    // Inicia la música del menú principal al cargar la página
    window.addEventListener('load', () => {
      playMusic("background_inicio.mp3");
    });
    function playMusic(src) {
      bgMusic.pause();
      bgMusic.src = src;
      bgMusic.load();
      bgMusic.play().catch(err => { console.log("Autoplay bloqueado:", err); });
    }
    // La función updateBackgroundMusic diferencia vistas:
    function updateBackgroundMusic(viewId) {
      if (viewId === 'main-menu') {
        playMusic("background_inicio.mp3");
      } else if (viewId === 'character-selection') {
        // En la selección de personajes, se mantiene la música del menú
        if (bgMusic.src.indexOf("background_inicio.mp3") === -1) {
          playMusic("background_inicio.mp3");
        }
      } else if (viewId === 'combat') {
        const combatTracks = [
          "background_combat1.mp3",
          "background_combat2.mp3",
          "background_combat3.mp3"
        ];
        const chosenTrack = combatTracks[Math.floor(Math.random() * combatTracks.length)];
        playMusic(chosenTrack);
      } else if (viewId === 'result') {
        bgMusic.pause();
      }
    }
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      updateBackgroundMusic(viewId);
    }

    /*************************************
     * BOTÓN PARA PAUSAR/REANUDAR MÚSICA DEL MENÚ
     *************************************/
    document.getElementById('btn-toggle-menu-music').addEventListener('click', function() {
      // Solo actuamos si estamos en el menú principal
      if (document.getElementById('main-menu').classList.contains('active')) {
        if (bgMusic.paused) {
          bgMusic.play();
          this.textContent = "Pausar Música";
        } else {
          bgMusic.pause();
          this.textContent = "Reanudar Música";
        }
      }
    });

    /*************************************
     * MODAL DE PERSONAJE
     *************************************/
    let currentModalCharacter = "";
    function showCharacterModal(name) {
      const char = characters[name];
      currentModalCharacter = name;
      document.getElementById('modal-character-name').textContent = name;
      document.getElementById('modal-character-img').src = char.image;
      document.getElementById('modal-character-desc').textContent = char.description || "Sin detalles disponibles.";
      document.getElementById('character-modal').style.display = 'block';
    }
    function hideCharacterModal() {
      document.getElementById('character-modal').style.display = 'none';
    }
    function confirmCharacterSelection() {
      hideCharacterModal();
      selectCharacterConfirmed(currentModalCharacter);
    }

    /*************************************
     * SELECCIÓN DE PERSONAJES
     *************************************/
    function showCharacterSelection() {
      showView('character-selection');
      const header = document.getElementById('selection-header');
      header.textContent = (gameMode === "vs_ai")
                           ? "Selecciona tu Fumador"
                           : (currentPlayer === 1 ? "Jugador 1: Selecciona tu Fumador" : "Jugador 2: Selecciona tu Fumador");
      const list = document.getElementById('character-list');
      list.innerHTML = "";
      for (const name in characters) {
        const card = document.createElement('div');
        card.classList.add('character-card');
        card.innerHTML = `<img src="${characters[name].image}" alt="${name}">
                          <p>${name}</p>`;
        card.addEventListener('click', () => showCharacterModal(name));
        list.appendChild(card);
      }
    }
    function selectCharacterConfirmed(name) {
      if (gameMode === "vs_ai") {
        player1Character = name;
        const available = Object.keys(characters).filter(c => c !== name);
        player2Character = available[Math.floor(Math.random() * available.length)];
        startCombat();
      } else if (gameMode === "duel") {
        if (currentPlayer === 1) {
          player1Character = name;
          currentPlayer = 2;
          showCharacterSelection();
        } else {
          player2Character = name;
          startCombat();
        }
      }
    }

    /*************************************
     * INICIAR COMBATE (YA CON PERSONAJES SELECCIONADOS)
     *************************************/
    function startCombat() {
      gameOver = false;
      if (gameMode === "vs_ai") { iaExperience++; }
      player1 = {
        name: player1Character,
        character: player1Character,
        bullets: characters[player1Character].initialBullets,
        health: initialHealth,
        defenseActive: false,
        lastAction: null,
        currentSuicideChance: (player1Character === "Kurt Cobain") ? 0.25 : 0
      };
      player2 = {
        name: player2Character,
        character: player2Character,
        bullets: characters[player2Character].initialBullets,
        health: initialHealth,
        defenseActive: false,
        lastAction: null,
        currentSuicideChance: (player2Character === "Kurt Cobain") ? 0.25 : 0
      };
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      // Al iniciar el combate, cambiamos a música de combate.
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    function updateScoreboard() {
      document.getElementById('player1-name').textContent = player1.name;
      document.getElementById('player1-health').textContent = player1.health;
      document.getElementById('player1-bullets').textContent = player1.bullets;
      document.getElementById('player2-name').textContent = player2.name;
      document.getElementById('player2-health').textContent = player2.health;
      document.getElementById('player2-bullets').textContent = player2.bullets;
    }
    function updateCurrentTurnInfo() {
      const current = (currentPlayer === 1) ? player1 : player2;
      document.getElementById('turn-header').textContent = "TURNO DE " + current.name;
      document.getElementById('current-turn-img').src = characters[current.character].image;
      document.getElementById('current-turn-info').textContent = "Balas: " + current.bullets + " | Health: " + current.health;
      if (current.character === "El Xokas") {
        updatePrediction();
      } else {
        document.getElementById('prediction').textContent = "";
      }
    }
    // Función para que El Xokas prediga la acción del oponente.
    function updatePrediction() {
      const predictionEl = document.getElementById('prediction');
      const opponent = (currentPlayer === 1) ? player2 : player1;
      const allowed = [];
      if (opponent.bullets > 0) { allowed.push("disparar"); }
      if (opponent.bullets < characters[opponent.character].initialBullets) { allowed.push("recargar"); }
      if (opponent.lastAction !== "defender") { allowed.push("defender"); }
      if (allowed.length === 0) { predictionEl.textContent = "Sin acciones para predecir."; return; }
      if (Math.random() < 0.75) {
        const predicted = allowed[Math.floor(Math.random() * allowed.length)];
        predictionEl.textContent = "El Xokas predice: " + predicted;
      } else {
        predictionEl.textContent = "";
      }
    }
    /*************************************
     * MOSTRAR OPCIONES DE COMBATE DEL JUGADOR ACTIVO
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      const allowedActions = [];
      if (current.bullets > 0) { allowedActions.push("disparar"); }
      if (current.bullets > 0 && current.character !== "Amongolito") { allowedActions.push("suicidarse"); }
      if (current.bullets < characters[current.character].initialBullets) { allowedActions.push("recargar"); }
      if (current.lastAction !== "defender") { allowedActions.push("defender"); }
      allowedActions.forEach(action => {
        const btn = document.createElement('button');
        btn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
        btn.addEventListener('click', () => {
          if (current.character === "Kurt Cobain" && action === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: action, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }
    /*************************************
     * SUBMIT DE ACCIÓN (SECUENCIAL)
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }
    /*************************************
     * RESOLUCIÓN DEL TURNO (SECUENCIAL)
     *************************************/
    function resolveTurn() {
      const a1Obj = turnActions[1];
      const a2Obj = turnActions[2];
      const a1 = a1Obj.action, a2 = a2Obj.action;
      const b1 = a1Obj.bulletsSpent, b2 = a2Obj.bulletsSpent;
      let outcomeMessage = "";
      
      if (a1 === "disparar" || a1 === "suicidarse") { player1.bullets = Math.max(0, player1.bullets - b1); }
      if (a2 === "disparar" || a2 === "suicidarse") { player2.bullets = Math.max(0, player2.bullets - b2); }
      
      // Regla especial para Amongolito: si el oponente se suicida, Amongolito se asusta y muere.
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        outcomeMessage = player2.name + " gana, porque Amongolito se asustó y murió al ver el suicidio.";
        gameOver = true;
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        outcomeMessage = player1.name + " gana, porque Amongolito se asustó y murió al ver el suicidio.";
        gameOver = true;
      }
      // Resolver acciones de suicidio:
      else if(a1 === "suicidarse" && a2 === "suicidarse") {
        outcomeMessage = "Ambos se suicidaron. ¡Empate!";
        gameOver = true;
      } else if(a1 === "suicidarse" && a2 === "defender") {
        outcomeMessage = player1.name + " se suicidó contra la defensa y gana.";
        gameOver = true;
      } else if(a2 === "suicidarse" && a1 === "defender") {
        outcomeMessage = player2.name + " se suicidó contra la defensa y gana.";
        gameOver = true;
      } else if(a1 === "suicidarse" && a2 !== "defender") {
        outcomeMessage = player1.name + " se suicidó y pierde. " + player2.name + " gana.";
        gameOver = true;
      } else if(a2 === "suicidarse" && a1 !== "defender") {
        outcomeMessage = player2.name + " se suicidó y pierde. " + player1.name + " gana.";
        gameOver = true;
      }
      
      if (!gameOver) {
        if(a1 === "disparar") {
          if(a2 !== "defender") {
            player2.health--;
            outcomeMessage += player1.name + " disparó y dañó a " + player2.name + ". ";
          } else {
            outcomeMessage += player1.name + " disparó, pero " + player2.name + " se defendió. ";
          }
        }
        if(a2 === "disparar") {
          if(a1 !== "defender") {
            player1.health--;
            outcomeMessage += player2.name + " disparó y dañó a " + player1.name + ". ";
          } else {
            outcomeMessage += player2.name + " disparó, pero " + player1.name + " se defendió. ";
          }
        }
        if(a1 === "recargar") {
          if (player1.bullets < characters[player1.character].initialBullets) {
            player1.bullets++;
            outcomeMessage += player1.name + " recargó y ganó una bala. ";
          }
        }
        if(a2 === "recargar") {
          if (player2.bullets < characters[player2.character].initialBullets) {
            player2.bullets++;
            outcomeMessage += player2.name + " recargó y ganó una bala. ";
          }
        }
        if(a1 === "defender") { outcomeMessage += player1.name + " se defendió. "; }
        if(a2 === "defender") { outcomeMessage += player2.name + " se defendió. "; }
      }
      
      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMessage;
      
      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        if(player1.health <= 0 && player2.health <= 0) {
          outcomeMessage = "¡Ambos han caído! Empate.";
        } else if(player1.health <= 0) {
          outcomeMessage = player2.name + " gana, ¡" + player1.name + " ha sido derrotado!";
        } else {
          outcomeMessage = player1.name + " gana, ¡" + player2.name + " ha sido derrotado!";
        }
        document.getElementById('combat-result').textContent = outcomeMessage;
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") { player1.currentSuicideChance = 0.25; }
        if (player2.character === "Kurt Cobain") { player2.currentSuicideChance = 0.25; }
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMessage.indexOf(player1.name) !== -1) { botDefensiveBias++; }
          else if (outcomeMessage.indexOf(player2.name) !== -1) { botDefensiveBias = Math.max(botDefensiveBias - 1, 0); }
        }
        setTimeout(() => { showResult(outcomeMessage); }, 1500);
      } else {
        turnActions = { 1: null, 2: null };
        currentPlayer = 1;
        player1.defenseActive = false;
        updateCurrentTurnInfo();
        showCombatOptions();
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 1500);
      }
    }
    /*************************************
     * ACCIÓN DE LA IA (VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" && player2.bullets > 0 && player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possibleActions = [];
      if (difficulty === "easy") {
        possibleActions = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const weight = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < weight; i++) { possibleActions.push("disparar"); }
        }
        possibleActions.push("recargar", "defender");
        if (Math.random() < 0.1) { possibleActions.push("suicidarse"); }
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const weight = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < weight; i++) { possibleActions.push("disparar"); }
        } else {
          possibleActions.push("recargar", "recargar");
        }
        possibleActions.push("defender");
        if (Math.random() < 0.05) { possibleActions.push("suicidarse"); }
      }
      const action = possibleActions[Math.floor(Math.random() * possibleActions.length)];
      turnActions[2] = { action: action, bulletsSpent: 1 };
      resolveTurn();
    }
    /*************************************
     * PANTALLA DE RESULTADO
     *************************************/
    function showResult(message) {
      document.getElementById('result-message').textContent = message;
      showView('result');
    }
    /*************************************
     * EVENTOS DE LOS BOTONES DEL MENÚ
     *************************************/
    document.getElementById('btn-vs-ai').addEventListener('click', () => {
      gameMode = "vs_ai";
      currentPlayer = 1;
      difficulty = prompt("Selecciona el nivel de dificultad (easy, medium, hard):", "medium") || "medium";
      showCharacterSelection();
    });
    document.getElementById('btn-duel').addEventListener('click', () => {
      gameMode = "duel";
      currentPlayer = 1;
      showCharacterSelection();
    });
    document.getElementById('btn-back-main').addEventListener('click', () => { showView('main-menu'); });
    document.getElementById('btn-return-main').addEventListener('click', () => { showView('main-menu'); });
    /*************************************
     * EVENTOS DEL MODAL DE PERSONAJE
     *************************************/
    document.getElementById('btn-confirm-character').addEventListener('click', confirmCharacterSelection);
    document.getElementById('btn-cancel-character').addEventListener('click', hideCharacterModal);
    /*************************************
     * CONTROL DE VOLUMEN (MENÚ PRINCIPAL)
     *************************************/
    document.getElementById('volume-slider').addEventListener('input', function() {
      bgMusic.volume = parseFloat(this.value);
    });
  </script>
  <!-- Si no existe el slider, se crea -->
  <script>
    if (!document.getElementById('volume-slider')) {
      const volumeControl = document.createElement('div');
      volumeControl.id = "volume-control";
      volumeControl.innerHTML = `<label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">`;
      document.getElementById('main-menu').appendChild(volumeControl);
    }
  </script>
</body>
</html>
