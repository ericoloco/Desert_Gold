<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- La etiqueta base hace que las rutas relativas se resuelvan desde la misma carpeta -->
  <base href="./">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Desert Gold</title>

  <!-- Cargar Socket.io (para el modo online) -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <style>
    /* RESET Y ESTILOS BÁSICOS */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: sans-serif;
      background-color: #222;
      color: #eee;
      line-height: 1.5;
    }
    #app {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }
    .view {
      display: none;
    }
    .active {
      display: block;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #555;
      color: #eee;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #777;
    }

    /* Botón de GUÍA en la esquina inferior izquierda */
    #btn-guide {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
      background-color: #444;
    }

    /* CARTAS DE PERSONAJES */
    .character-card {
      display: inline-block;
      width: 150px;
      margin: 10px;
      text-align: center;
      cursor: pointer;
      border: 1px solid #555;
      border-radius: 8px;
      overflow: hidden;
      background-color: #333;
      transition: transform 0.2s;
    }
    .character-card:hover {
      transform: scale(1.05);
    }
    .character-card img {
      width: 100%;
      height: auto;
    }
    .character-card p {
      margin: 0.5rem;
    }

    /* VISTAS: MENÚ, SELECCIÓN, RESULTADO */
    #main-menu, #character-selection, #result {
      text-align: center;
      padding: 1rem;
    }

    /* COMBATE */
    #combat {
      padding: 1rem;
    }

    /* Scoreboard */
    #scoreboard {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    #scoreboard div {
      text-align: center;
    }

    /* Información del turno */
    #current-turn {
      text-align: center;
      margin-bottom: 1rem;
    }
    #current-turn img {
      max-width: 200px;
      border: 3px solid #555;
      border-radius: 50%;
      margin: 0 auto;
      display: block;
    }
    #action-buttons {
      text-align: center;
      margin: 1rem 0;
    }
    #combat-result {
      text-align: center;
      margin: 0.5rem 0;
      font-style: italic;
    }

    /* Predicción para El Xokas */
    #prediction {
      text-align: center;
      margin-bottom: 1rem;
      font-style: italic;
      color: #ccc;
    }

    /* Control de volumen */
    #volume-control {
      text-align: center;
      margin-top: 1rem;
    }
    #volume-control label {
      margin-right: 0.5rem;
    }

    /* MEDIA QUERIES */
    @media (max-width: 600px) {
      button {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
      }
      h1 {
        font-size: 1.75rem;
      }
      h2 {
        font-size: 1.25rem;
      }
    }

    /* MODAL DE PERSONAJE Y GUÍA */
    .modal {
      display: none;
      position: fixed;
      z-index: 1500;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background-color: #333;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #555;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      text-align: left;
      color: #eee;
    }
    .modal-content h2 {
      text-align: center;
    }
    .modal-content p {
      margin: 0.5rem 0;
    }
    .modal-buttons {
      margin-top: 1rem;
      text-align: center;
    }
    .modal-buttons button {
      margin: 0.5rem;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- MENÚ PRINCIPAL -->
    <div id="main-menu" class="view active">
      <h1>Desert Gold</h1>
      <h2>El Tabaco</h2>
      <button id="btn-vs-ai">Combate VS IA</button>
      <button id="btn-duel">Duelo de Fumadores</button>
      <!-- Modo Online: CIGARROS ELECTRÓNICOS -->
      <button id="btn-online">CIGARROS ELECTRÓNICOS (Online)</button>
      <button id="btn-toggle-menu-music">Pausar Música</button>
      <div id="volume-control">
        <label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>

    <!-- SELECCIÓN DE PERSONAJES -->
    <div id="character-selection" class="view">
      <h2 id="selection-header">Selecciona tu Fumador</h2>
      <div id="character-list"></div>
      <button id="btn-back-main">Volver al Menú Principal</button>
    </div>

    <!-- PANTALLA DE COMBATE -->
    <div id="combat" class="view">
      <div id="scoreboard">
        <div id="player1-score">
          <span id="player1-name">Jugador 1</span><br>
          Health: <span id="player1-health">3</span><br>
          Balas: <span id="player1-bullets">0</span>
        </div>
        <div id="player2-score">
          <span id="player2-name">Jugador 2</span><br>
          Health: <span id="player2-health">3</span><br>
          Balas: <span id="player2-bullets">0</span>
        </div>
      </div>
      <div id="current-turn">
        <h2 id="turn-header">TURNO DE</h2>
        <img id="current-turn-img" src="" alt="Jugador Actual">
        <p id="current-turn-info"></p>
        <p id="prediction"></p>
      </div>
      <div id="action-buttons"></div>
      <div id="combat-result"></div>
    </div>

    <!-- PANTALLA DE RESULTADO -->
    <div id="result" class="view">
      <h2 id="result-message"></h2>
      <button id="btn-restart-game">Reiniciar Partida</button>
      <button id="btn-choose-character">Volver a Elegir Personaje</button>
    </div>
  </div>

  <!-- MODAL PARA DETALLES DEL PERSONAJE -->
  <div id="character-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-character-name"></h2>
      <img id="modal-character-img" src="" alt="Imagen del personaje">
      <p id="modal-character-desc"></p>
      <div class="modal-buttons">
        <button id="btn-confirm-character">Seleccionar</button>
        <button id="btn-cancel-character">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL PARA LA GUÍA DEL JUEGO -->
  <div id="guide-modal" class="modal">
    <div class="modal-content">
      <h2>Guía de Juego - Desert Gold</h2>
      <p><strong>Introducción:</strong> Bienvenido a <em>Desert Gold</em>, un juego de estrategia y habilidad donde te enfrentarás a la IA, a otro jugador en duelo local o en línea (modo <em>CIGARROS ELECTRÓNICOS</em>). ¡Prepara tu estrategia y demuestra quién es el mejor fumador!</p>
      <p><strong>Modos de Juego:</strong></p>
      <ul>
        <li><strong>Combate VS IA:</strong> Enfréntate a la inteligencia artificial, que mejora su estrategia en cada combate.</li>
        <li><strong>Duelo de Fumadores (Local):</strong> Dos jugadores se turnan en la misma máquina. Si ambos eligen el mismo personaje, se crean instancias separadas para evitar acciones duplicadas.</li>
        <li><strong>CIGARROS ELECTRÓNICOS (Online):</strong> Juega en línea contra otro jugador. Ingresa tu nickname y comparte el enlace de la sala para que ambos seleccionen personajes y jueguen un combate remoto.</li>
      </ul>
      <p><strong>Selección de Personajes:</strong> Cada personaje tiene habilidades únicas:</p>
      <ul>
        <li><strong>Pepe:</strong> Equilibrado y sencillo.</li>
        <li><strong>Manueh:</strong> Más balas, pero sin defensa (no puede usar “defender”).</li>
        <li><strong>Kurt Cobain:</strong> Cada disparo aumenta su probabilidad de suicidio un 25%.</li>
        <li><strong>El Xokas:</strong> Puede predecir la acción del rival (se muestra en pantalla).</li>
        <li><strong>Rajoy:</strong> Muy resistente, pocas balas.</li>
        <li><strong>Amongolito:</strong> No puede suicidarse y dispone de la acción “sus” contra suicidios.</li>
      </ul>
      <p><strong>Mecánica del Combate:</strong> Cada turno, el jugador activo elige entre:</p>
      <ul>
        <li><strong>Disparar</strong> (requiere bala),</li>
        <li><strong>Recargar</strong> (si no se tienen balas máximas),</li>
        <li><strong>Defender</strong> (salvo Manueh),</li>
        <li><strong>Suicidarse</strong> (no para Amongolito),</li>
        <li><strong>Sus</strong> (solo Amongolito, defiende contra suicidios).</li>
      </ul>
      <p><strong>Objetivo:</strong> ¡Deja sin salud a tu oponente o haz uso de tus habilidades para sobrevivir hasta ganar!</p>
      <div class="modal-buttons">
        <button id="btn-close-guide">Cerrar Guía</button>
      </div>
    </div>
  </div>

  <!-- Botón fijo para abrir la GUÍA -->
  <button id="btn-guide">GUÍA</button>

  <script>
    /*************************************
     * EVENTOS DEL MODAL DE PERSONAJE
     *************************************/
    let currentModalCharacter = "";
    function showCharacterModal(name) {
      const char = characters[name];
      currentModalCharacter = name;
      document.getElementById('modal-character-name').textContent = name;
      document.getElementById('modal-character-img').src = char.image;
      document.getElementById('modal-character-desc').textContent = char.description || "Sin detalles disponibles.";
      document.getElementById('character-modal').style.display = 'block';
    }
    function hideCharacterModal() {
      document.getElementById('character-modal').style.display = 'none';
    }
    function confirmCharacterSelection() {
      hideCharacterModal();
      selectCharacterConfirmed(currentModalCharacter);
    }

    // Asignar event listeners a los botones del modal de personaje
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-confirm-character').addEventListener('click', confirmCharacterSelection);
      document.getElementById('btn-cancel-character').addEventListener('click', hideCharacterModal);
    });

    /*************************************
     * EVENTOS DEL MODAL DE GUÍA
     *************************************/
    document.getElementById('btn-guide').addEventListener('click', () => {
      document.getElementById('guide-modal').style.display = 'block';
    });
    document.getElementById('btn-close-guide').addEventListener('click', () => {
      document.getElementById('guide-modal').style.display = 'none';
    });

    /*************************************
     * VARIABLES PARA MODO ONLINE
     *************************************/
    let socket = null;
    let roomId = null;
    let nickname = "";
    let opponentNickname = "";
    let isHost = false;
    let playerIndex = 1; // 1 o 2, asignado por el servidor

    /*************************************
     * DATOS Y ESTADO DEL JUEGO
     *************************************/
    const characters = {
      "Pepe": {
        image: "pepe.png",
        initialBullets: 2,
        description: "Equilibrado y sencillo, sin mecánicas especiales."
      },
      "Manueh": {
        image: "manueh.png",
        initialBullets: 3,
        description: "Tiene más balas pero no puede defender; ideal para ataques directos."
      },
      "Kurt Cobain": {
        image: "kurtcobain.png",
        initialBullets: 4,
        suicideChance: 0.25,
        description: "Tiene más balas y cada disparo aumenta su probabilidad de suicidio en un 25%."
      },
      "El Xokas": {
        image: "xokas.png",
        initialBullets: 1,
        predictChance: 1,
        description: "Experto en trucos con cigarros, ¿qué más quieres?"
      },
      "Rajoy": {
        image: "rajoy.png",
        initialBullets: 1,
        description: "Resistente, con capacidad para defender varias veces, pero con pocas balas."
      },
      "Amongolito": {
        image: "amongolito.png",
        initialBullets: 2,
        description: "No puede suicidarse y tiene la acción 'sus' para protegerse de suicidios."
      }
    };

    let gameMode = "";      // "vs_ai", "duel", "online"
    let currentPlayer = 1;
    let player1Character = "";
    let player2Character = "";
    let turnActions = { 1: null, 2: null };
    let gameOver = false;

    let iaExperience = 0;
    let botDefensiveBias = 0;
    const initialHealth = 3;
    let player1 = null;
    let player2 = null;
    let difficulty = "medium";

    /*************************************
     * CONTROL DE MÚSICA DE FONDO
     *************************************/
    const bgMusic = new Audio();
    bgMusic.loop = true;
    window.addEventListener('load', () => {
      playMusic("background_inicio.mp3");
    });
    function playMusic(src) {
      bgMusic.pause();
      bgMusic.src = src;
      bgMusic.load();
      bgMusic.play().catch(err => { console.log("Autoplay bloqueado:", err); });
    }
    function updateBackgroundMusic(viewId) {
      if (viewId === 'main-menu') {
        playMusic("background_inicio.mp3");
      } else if (viewId === 'character-selection') {
        if (!bgMusic.src.includes("background_inicio.mp3")) {
          playMusic("background_inicio.mp3");
        }
      } else if (viewId === 'combat') {
        const combatTracks = [
          "background_combat1.mp3",
          "background_combat2.mp3",
          "background_combat3.mp3"
        ];
        const chosenTrack = combatTracks[Math.floor(Math.random() * combatTracks.length)];
        playMusic(chosenTrack);
      } else if (viewId === 'result') {
        bgMusic.pause();
      }
    }
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      updateBackgroundMusic(viewId);
    }

    /*************************************
     * EVENTOS DE MENÚ
     *************************************/
    document.getElementById('btn-vs-ai').addEventListener('click', () => {
      gameMode = "vs_ai";
      currentPlayer = 1;
      difficulty = prompt("Selecciona el nivel de dificultad (easy, medium, hard):", "medium") || "medium";
      showCharacterSelection();
    });
    document.getElementById('btn-duel').addEventListener('click', () => {
      gameMode = "duel";
      currentPlayer = 1;
      showCharacterSelection();
    });
    // Modo Online
    document.getElementById('btn-online').addEventListener('click', () => {
      gameMode = "online";
      nickname = prompt("Ingresa tu nickname para el modo online:");
      if (!nickname) return;

      const params = new URLSearchParams(window.location.search);
      roomId = params.get('room');
      if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 8);
        isHost = true;
        // Actualiza la URL con la sala
        window.history.replaceState({}, '', window.location.pathname + '?room=' + roomId);
      } else {
        isHost = false;
      }
      socket = io('http://localhost:3000');
      socket.emit('joinOnlineGame', { room: roomId, nickname });

      socket.on('roomFull', (data) => {
        alert(data.message);
        showView('main-menu');
      });
      socket.on('joinedRoom', (data) => {
        console.log("Te uniste a la sala:", data.room);
      });
      socket.on('roomReady', (data) => {
        alert(data.message); // "Dos jugadores en la sala. Elijan sus personajes."
        showCharacterSelection();
      });
      socket.on('onlineGameStarted', (data) => {
        playerIndex = data.playerIndex; // 1 o 2
        opponentNickname = data.opponentNickname;
        player1Character = data.player1Char;
        player2Character = data.player2Char;
        startCombatOnline();
      });
      socket.on('receivePlayerAction', (data) => {
        if (data.nickname !== nickname) {
          let remoteIndex = (playerIndex === 1) ? 2 : 1;
          turnActions[remoteIndex] = { action: data.action, bulletsSpent: data.bulletsSpent };
          // Si ya tenemos nuestras dos acciones, resolvemos
          if (turnActions[playerIndex] && turnActions[remoteIndex]) {
            resolveTurnOnline();
          }
        }
      });

      showView('main-menu');
    });
    document.getElementById('btn-toggle-menu-music').addEventListener('click', function() {
      if (document.getElementById('main-menu').classList.contains('active')) {
        if (bgMusic.paused) {
          bgMusic.play();
          this.textContent = "Pausar Música";
        } else {
          bgMusic.pause();
          this.textContent = "Reanudar Música";
        }
      }
    });
    document.getElementById('btn-back-main').addEventListener('click', () => {
      showView('main-menu');
    });
    document.getElementById('btn-return-main').addEventListener('click', () => {
      showView('main-menu');
    });

    /*************************************
     * EVENTOS DE RESULTADO
     *************************************/
    // Botones de la pantalla final
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-restart-game').addEventListener('click', () => {
        // Reinicia la partida con los mismos personajes
        if (gameMode === "online") {
          startCombatOnline();
        } else {
          startCombatLocal();
        }
      });
      document.getElementById('btn-choose-character').addEventListener('click', () => {
        showCharacterSelection();
      });
    });

    /*************************************
     * SELECCIÓN DE PERSONAJES
     *************************************/
    function showCharacterSelection() {
      showView('character-selection');
      const header = document.getElementById('selection-header');
      header.textContent = (gameMode === "vs_ai" || gameMode === "online")
        ? "Selecciona tu Fumador"
        : (currentPlayer === 1 ? "Jugador 1: Selecciona tu Fumador" : "Jugador 2: Selecciona tu Fumador");
      const list = document.getElementById('character-list');
      list.innerHTML = "";
      for (const name in characters) {
        const card = document.createElement('div');
        card.classList.add('character-card');
        card.innerHTML = `
          <img src="${characters[name].image}" alt="${name}">
          <p>${name}</p>
        `;
        card.addEventListener('click', () => showCharacterModal(name));
        list.appendChild(card);
      }
    }
    function selectCharacterConfirmed(name) {
      if (gameMode === "vs_ai") {
        player1Character = name;
        const available = Object.keys(characters).filter(c => c !== name);
        player2Character = available[Math.floor(Math.random() * available.length)];
        startCombatLocal();
      } else if (gameMode === "duel") {
        if (currentPlayer === 1) {
          player1Character = name;
          currentPlayer = 2;
          showCharacterSelection();
        } else {
          player2Character = name;
          currentPlayer = 1;
          startCombatLocal();
        }
      } else if (gameMode === "online") {
        socket.emit('characterSelected', {
          room: roomId,
          nickname,
          character: name
        });
        showView('main-menu'); // Espera a onlineGameStarted
      }
    }

    /*************************************
     * COMBATE LOCAL
     *************************************/
    function startCombatLocal() {
      gameOver = false;
      if (gameMode === "vs_ai") {
        iaExperience++;
      }
      player1 = createPlayer(player1Character);
      player2 = createPlayer(player2Character);
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }

    /*************************************
     * COMBATE ONLINE
     *************************************/
    function startCombatOnline() {
      gameOver = false;
      player1 = createPlayer(player1Character, nickname);
      player2 = createPlayer(player2Character, opponentNickname);
      turnActions = { 1: null, 2: null };
      currentPlayer = playerIndex; // El local inicia si es 1, el remoto si es 2
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptionsOnline();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }

    function createPlayer(characterName, customName) {
      return {
        name: customName || characterName,
        character: characterName,
        bullets: characters[characterName].initialBullets,
        health: initialHealth,
        defenseActive: false,
        lastAction: null,
        currentSuicideChance: (characterName === "Kurt Cobain") ? 0.25 : 0
      };
    }

    /*************************************
     * UI DE COMBATE (INFORMACIÓN)
     *************************************/
    function updateScoreboard() {
      document.getElementById('player1-name').textContent = player1.name;
      document.getElementById('player1-health').textContent = player1.health;
      document.getElementById('player1-bullets').textContent = player1.bullets;

      document.getElementById('player2-name').textContent = player2.name;
      document.getElementById('player2-health').textContent = player2.health;
      document.getElementById('player2-bullets').textContent = player2.bullets;
    }
    function updateCurrentTurnInfo() {
      const current = (currentPlayer === 1) ? player1 : player2;
      document.getElementById('turn-header').textContent = "TURNO DE " + current.name;
      document.getElementById('current-turn-img').src = characters[current.character].image;
      document.getElementById('current-turn-info').textContent = `Balas: ${current.bullets} | Health: ${current.health}`;

      if (current.character === "El Xokas") {
        updatePrediction();
      } else {
        document.getElementById('prediction').textContent = "";
      }
    }
    function updatePrediction() {
      const predictionEl = document.getElementById('prediction');
      const opponent = (currentPlayer === 1) ? player2 : player1;
      const allowed = [];
      if (opponent.bullets > 0) {
        allowed.push("disparar");
      }
      if (opponent.bullets < characters[opponent.character].initialBullets) {
        allowed.push("recargar");
      }
      if (opponent.lastAction !== "defender") {
        allowed.push("defender");
      }
      if (!allowed.length) {
        predictionEl.textContent = "Sin acciones para predecir.";
        return;
      }
      const predicted = allowed[Math.floor(Math.random() * allowed.length)];
      predictionEl.textContent = "El Xokas predice: " + predicted;
    }

    /*************************************
     * OPCIONES DE COMBATE (ONLINE)
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";

      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        // Es mi turno
        const current = (currentPlayer === 1) ? player1 : player2;
        const allowedActions = [];
        if (current.bullets > 0) {
          allowedActions.push("disparar");
        }
        if (current.bullets > 0 && current.character !== "Amongolito") {
          allowedActions.push("suicidarse");
        }
        if (current.bullets < characters[current.character].initialBullets) {
          allowedActions.push("recargar");
        }
        // Manueh no puede defender
        if (current.lastAction !== "defender" && current.character !== "Manueh") {
          allowedActions.push("defender");
        }
        if (current.character === "Amongolito") {
          allowedActions.push("sus");
        }

        allowedActions.forEach(action => {
          const btn = document.createElement('button');
          btn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
          btn.addEventListener('click', () => {
            // Limitar a una acción por turno
            if (turnActions[playerIndex] !== null) return;

            if (current.character === "Kurt Cobain" && action === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', {
                  room: roomId,
                  nickname,
                  action: "suicidarse",
                  bulletsSpent: 1,
                  playerIndex
                });
                return;
              }
            }

            turnActions[playerIndex] = { action, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', {
              room: roomId,
              nickname,
              action,
              bulletsSpent: 1,
              playerIndex
            });
          });
          container.appendChild(btn);
        });
      } else {
        // Turno del otro
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * OPCIONES DE COMBATE (LOCAL)
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";

      const current = (currentPlayer === 1) ? player1 : player2;
      const allowedActions = [];
      if (current.bullets > 0) {
        allowedActions.push("disparar");
      }
      if (current.bullets > 0 && current.character !== "Amongolito") {
        allowedActions.push("suicidarse");
      }
      if (current.bullets < characters[current.character].initialBullets) {
        allowedActions.push("recargar");
      }
      // Manueh no puede defender
      if (current.lastAction !== "defender" && current.character !== "Manueh") {
        allowedActions.push("defender");
      }
      if (current.character === "Amongolito") {
        allowedActions.push("sus");
      }

      allowedActions.forEach(action => {
        const btn = document.createElement('button');
        btn.textContent = action.charAt(0).toUpperCase() + action.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;

          if (current.character === "Kurt Cobain" && action === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * LÓGICA DE ENVÍO DE ACCIONES (LOCAL)
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;

      // Si es duelo local
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        // Jugador 1 hace su acción, IA responde
        botChooseAction();
      }
    }

    /*************************************
     * RESOLUCIÓN DE TURNOS
     *************************************/
    function resolveTurn() {
      const a1Obj = turnActions[1];
      const a2Obj = turnActions[2];
      const a1 = a1Obj.action;
      const a2 = a2Obj.action;
      const b1 = a1Obj.bulletsSpent;
      const b2 = a2Obj.bulletsSpent;
      let outcomeMessage = "";

      // Descontar balas
      if (["disparar", "suicidarse"].includes(a1)) {
        player1.bullets = Math.max(0, player1.bullets - b1);
      }
      if (["disparar", "suicidarse"].includes(a2)) {
        player2.bullets = Math.max(0, player2.bullets - b2);
      }

      // Comprobar suicidios y Amongolito
      outcomeMessage = handleSuicidesAndAmongolito(a1, a2);

      // Si no ha terminado la partida, revisar disparos, recargas, defensas
      if (!gameOver) {
        outcomeMessage += handleShotsAndRecargas(a1, a2);
      }

      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMessage;

      // Comprobar si alguien murió
      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMessage = handleDeath(outcomeMessage);
        document.getElementById('combat-result').textContent = outcomeMessage;
      }

      if (gameOver) {
        // Ajuste final para Kurt Cobain
        if (player1.character === "Kurt Cobain") {
          player1.currentSuicideChance = 0.25;
        }
        if (player2.character === "Kurt Cobain") {
          player2.currentSuicideChance = 0.25;
        }
        // Ajustes finales para IA
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMessage.includes(player1.name)) {
            botDefensiveBias++;
          } else if (outcomeMessage.includes(player2.name)) {
            botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
          }
        }
        // Mostrar el resultado 2 segundos extra => 3500 ms
        setTimeout(() => {
          showResult(outcomeMessage);
        }, 3500);
      } else {
        // Nadie ha muerto, siguiente turno
        turnActions = { 1: null, 2: null };

        if (gameMode === "online") {
          // Alternar
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        } else {
          currentPlayer = 1;
        }
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();

        if (gameMode === "online") {
          showCombatOptionsOnline();
        } else {
          showCombatOptions();
        }
        // Mantener el mensaje de resolución 2 segundos más => 3500 ms
        setTimeout(() => {
          document.getElementById('combat-result').textContent = "";
        }, 3500);
      }
    }

    function handleSuicidesAndAmongolito(a1, a2) {
      let msg = "";
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        if (a1 === "sus") {
          msg = `${player1.name} usó SUS y se protegió del suicidio de ${player2.name}. ¡Gana el turno!`;
        } else {
          msg = `${player2.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`;
          gameOver = true;
        }
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        if (a2 === "sus") {
          msg = `${player2.name} usó SUS y se protegió del suicidio de ${player1.name}. ¡Gana el turno!`;
        } else {
          msg = `${player1.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`;
          gameOver = true;
        }
      } else if (a1 === "suicidarse" && a2 === "suicidarse") {
        msg = "Ambos se suicidaron. ¡Empate!";
        gameOver = true;
      } else if (a1 === "suicidarse" && a2 === "defender") {
        msg = `${player1.name} se suicidó contra la defensa y gana.`;
        gameOver = true;
      } else if (a2 === "suicidarse" && a1 === "defender") {
        msg = `${player2.name} se suicidó contra la defensa y gana.`;
        gameOver = true;
      } else if (a1 === "suicidarse" && a2 !== "defender") {
        msg = `${player1.name} se suicidó y pierde. ${player2.name} gana.`;
        gameOver = true;
      } else if (a2 === "suicidarse" && a1 !== "defender") {
        msg = `${player2.name} se suicidó y pierde. ${player1.name} gana.`;
        gameOver = true;
      }
      return msg;
    }
    function handleShotsAndRecargas(a1, a2) {
      let msg = "";
      if (a1 === "disparar") {
        if (a2 !== "defender") {
          player2.health--;
          msg += `${player1.name} disparó y dañó a ${player2.name}. `;
        } else {
          msg += `${player1.name} disparó, pero ${player2.name} se defendió. `;
        }
      }
      if (a2 === "disparar") {
        if (a1 !== "defender") {
          player1.health--;
          msg += `${player2.name} disparó y dañó a ${player1.name}. `;
        } else {
          msg += `${player2.name} disparó, pero ${player1.name} se defendió. `;
        }
      }
      if (a1 === "recargar") {
        if (player1.bullets < characters[player1.character].initialBullets) {
          player1.bullets++;
          msg += `${player1.name} recargó y ganó una bala. `;
        }
      }
      if (a2 === "recargar") {
        if (player2.bullets < characters[player2.character].initialBullets) {
          player2.bullets++;
          msg += `${player2.name} recargó y ganó una bala. `;
        }
      }
      if (a1 === "defender") {
        msg += `${player1.name} se defendió. `;
      }
      if (a2 === "defender") {
        msg += `${player2.name} se defendió. `;
      }
      return msg;
    }
    function handleDeath(prevMessage) {
      let msg = prevMessage;
      if (player1.health <= 0 && player2.health <= 0) {
        msg = "¡Ambos han caído! Empate.";
      } else if (player1.health <= 0) {
        msg = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      } else {
        msg = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      }
      return msg;
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO (ONLINE)
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        resolveTurn();
      }
    }

    /*************************************
     * BOT IA (VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possibleActions = [];
      if (difficulty === "easy") {
        possibleActions = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const weight = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < weight; i++) {
            possibleActions.push("disparar");
          }
        }
        possibleActions.push("recargar", "defender");
        if (Math.random() < 0.1) {
          possibleActions.push("suicidarse");
        }
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const weight = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < weight; i++) {
            possibleActions.push("disparar");
          }
        } else {
          possibleActions.push("recargar", "recargar");
        }
        possibleActions.push("defender");
        if (Math.random() < 0.05) {
          possibleActions.push("suicidarse");
        }
      }
      const action = possibleActions[Math.floor(Math.random() * possibleActions.length)];
      turnActions[2] = { action, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * PANTALLA DE RESULTADO
     *************************************/
    function showResult(message) {
      document.getElementById('result-message').textContent = message;
      showView('result');
    }

    /*************************************
     * CONTROL DE VOLUMEN
     *************************************/
    document.getElementById('volume-slider').addEventListener('input', function() {
      bgMusic.volume = parseFloat(this.value);
    });
  </script>
  <script>
    // Si no existe el slider, se crea dinámicamente
    if (!document.getElementById('volume-slider')) {
      const volumeControl = document.createElement('div');
      volumeControl.id = "volume-control";
      volumeControl.innerHTML = `<label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">`;
      document.getElementById('main-menu').appendChild(volumeControl);
    }
  </script>
</body>
</html>


