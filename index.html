<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- Las rutas relativas se resuelven desde esta carpeta -->
  <base href="./">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Desert Gold</title>
  
  <!-- Cargar Socket.io para el modo online -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  
  <style>
    /* RESET y estilos básicos */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; background-color: #222; color: #eee; line-height: 1.5; }
    #app { max-width: 800px; margin: 0 auto; padding: 1rem; }
    .view { display: none; }
    .active { display: block; }
    h1, h2 { text-align: center; margin-bottom: 1rem; }
    button {
      padding: 0.75rem 1.5rem; margin: 0.5rem; font-size: 1rem;
      border: none; border-radius: 5px; background-color: #555; color: #eee; cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #777; }
    
    /* Botón de GUÍA en la esquina inferior izquierda */
    #btn-guide {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2000;
      background-color: #444;
    }
    
    /* CARTAS DE PERSONAJES */
    .character-card {
      display: inline-block;
      width: 150px;
      margin: 10px;
      text-align: center;
      cursor: pointer;
      border: 1px solid #555;
      border-radius: 8px;
      overflow: hidden;
      background-color: #333;
      transition: transform 0.2s;
    }
    .character-card:hover { transform: scale(1.05); }
    .character-card img { width: 100%; height: auto; }
    .character-card p { margin: 0.5rem; }
    
    /* VISTAS: MENÚ, SELECCIÓN, RESULTADO */
    #main-menu, #character-selection, #result { text-align: center; padding: 1rem; }
    
    /* COMBATE */
    #combat { padding: 1rem; }
    
    /* SCOREBOARD */
    #scoreboard {
      display: flex; justify-content: space-around; margin-bottom: 1rem; font-weight: bold;
    }
    #scoreboard div { text-align: center; }
    
    /* INFORMACIÓN DEL TURNO */
    #current-turn { text-align: center; margin-bottom: 1rem; }
    #current-turn img {
      max-width: 200px; border: 3px solid #555; border-radius: 50%; margin: 0 auto; display: block;
    }
    #action-buttons { text-align: center; margin: 1rem 0; }
    #combat-result { text-align: center; margin: 0.5rem 0; font-style: italic; }
    
    /* PREDICCIÓN (El Xokas) */
    #prediction { text-align: center; margin-bottom: 1rem; font-style: italic; color: #ccc; }
    
    /* CONTROL DE VOLUMEN */
    #volume-control { text-align: center; margin-top: 1rem; }
    #volume-control label { margin-right: 0.5rem; }
    
    /* MEDIA QUERIES */
    @media (max-width: 600px) {
      button { font-size: 0.9rem; padding: 0.5rem 1rem; }
      h1 { font-size: 1.75rem; }
      h2 { font-size: 1.25rem; }
    }
    
    /* MODALES (para personaje y guía) */
    .modal {
      display: none; position: fixed; z-index: 1500;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background-color: #333; margin: 10% auto; padding: 20px;
      border: 1px solid #555; width: 90%; max-width: 500px;
      border-radius: 8px; text-align: left; color: #eee;
    }
    .modal-content h2 { text-align: center; }
    .modal-content p { margin: 0.5rem 0; }
    .modal-buttons { margin-top: 1rem; text-align: center; }
    .modal-buttons button { margin: 0.5rem; }
  </style>
</head>
<body>
  <div id="app">
    <!-- MENÚ PRINCIPAL -->
    <div id="main-menu" class="view active">
      <h1>Desert Gold</h1>
      <h2>El Tabaco</h2>
      <button id="btn-vs-ai">Combate VS IA</button>
      <button id="btn-duel">Duelo de Fumadores</button>
      <button id="btn-online">CIGARROS ELECTRÓNICOS (Online)</button>
      <button id="btn-toggle-menu-music">Pausar Música</button>
      <div id="volume-control">
        <label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>
    
    <!-- SELECCIÓN DE PERSONAJES -->
    <div id="character-selection" class="view">
      <h2 id="selection-header">Selecciona tu Fumador</h2>
      <div id="character-list"></div>
      <button id="btn-back-main">Volver al Menú Principal</button>
    </div>
    
    <!-- PANTALLA DE COMBATE -->
    <div id="combat" class="view">
      <div id="scoreboard">
        <div id="player1-score">
          <span id="player1-name">Jugador 1</span><br>
          Health: <span id="player1-health">3</span><br>
          Balas: <span id="player1-bullets">0</span>
        </div>
        <div id="player2-score">
          <span id="player2-name">Jugador 2</span><br>
          Health: <span id="player2-health">3</span><br>
          Balas: <span id="player2-bullets">0</span>
        </div>
      </div>
      <div id="current-turn">
        <h2 id="turn-header">TURNO DE</h2>
        <img id="current-turn-img" src="" alt="Jugador Actual">
        <p id="current-turn-info"></p>
        <p id="prediction"></p>
      </div>
      <div id="action-buttons"></div>
      <div id="combat-result"></div>
    </div>
    
    <!-- PANTALLA DE RESULTADO (sólo muestra el mensaje y luego regresa al menú) -->
    <div id="result" class="view">
      <h2 id="result-message"></h2>
    </div>
  </div>
  
  <!-- MODAL PARA DETALLES DEL PERSONAJE -->
  <div id="character-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-character-name"></h2>
      <img id="modal-character-img" src="" alt="Imagen del personaje">
      <p id="modal-character-desc"></p>
      <div class="modal-buttons">
        <button id="btn-confirm-character">Seleccionar</button>
        <button id="btn-cancel-character">Cancelar</button>
      </div>
    </div>
  </div>
  
  <!-- MODAL PARA LA GUÍA -->
  <div id="guide-modal" class="modal">
    <div class="modal-content">
      <h2>Guía de Juego - Desert Gold</h2>
      <p><strong>Introducción:</strong> Bienvenido a <em>Desert Gold</em>. Podrás enfrentarte a la IA, jugar en duelo local o competir online en el modo <em>CIGARROS ELECTRÓNICOS</em>.</p>
      <p><strong>Modos:</strong></p>
      <ul>
        <li><strong>Combate VS IA:</strong> Enfréntate a una IA que aprende con cada combate.</li>
        <li><strong>Duelo Local:</strong> Dos jugadores se turnan en la misma máquina.</li>
        <li><strong>Online:</strong> Juega contra otro jugador. Ingresa tu nickname y comparte el enlace de la sala.</li>
      </ul>
      <p><strong>Personajes:</strong></p>
      <ul>
        <li><strong>Pepe:</strong> Equilibrado y sencillo.</li>
        <li><strong>Manueh:</strong> Más balas, pero no puede usar “defender”.</li>
        <li><strong>Kurt Cobain:</strong> Cada disparo aumenta su probabilidad de suicidio un 25%.</li>
        <li><strong>El Xokas:</strong> Alta probabilidad de predecir la acción rival.</li>
        <li><strong>Rajoy:</strong> Muy resistente, pero con pocas balas.</li>
        <li><strong>Amongolito:</strong> No puede suicidarse y dispone de la acción “sus” para protegerse.</li>
      </ul>
      <p><strong>Mecánica:</strong> En cada turno, el jugador activo elige entre disparar (requiere bala), recargar (si no tiene el máximo), defender (no disponible para Manueh), suicidarse (no para Amongolito) o “sus” (solo Amongolito). El objetivo es dejar sin salud al oponente o provocar su suicidio.</p>
      <div class="modal-buttons">
        <button id="btn-close-guide">Cerrar Guía</button>
      </div>
    </div>
  </div>
  
  <!-- Botón fijo para abrir la GUÍA -->
  <button id="btn-guide">GUÍA</button>
  
  <script>
    /*************************************
     * VARIABLES GLOBALES Y FUNCIONES COMUNES
     *************************************/
    // Datos de personajes
    const characters = {
      "Pepe": { image: "pepe.png", initialBullets: 2, description: "Equilibrado y sencillo, sin mecánicas especiales." },
      "Manueh": { image: "manueh.png", initialBullets: 3, description: "Tiene más balas pero no puede defender; ideal para ataques directos." },
      "Kurt Cobain": { image: "kurtcobain.png", initialBullets: 4, suicideChance: 0.25, description: "Cada disparo aumenta su probabilidad de suicidio un 25%." },
      "El Xokas": { image: "xokas.png", initialBullets: 1, predictChance: 1, description: "Experto en predecir la acción rival." },
      "Rajoy": { image: "rajoy.png", initialBullets: 1, description: "Muy resistente, con pocas balas." },
      "Amongolito": { image: "amongolito.png", initialBullets: 2, description: "No puede suicidarse; dispone de la acción 'sus'." }
    };

    // Variables de estado generales
    let gameMode = "";         // "vs_ai", "duel", "online"
    let currentPlayer = 1;       // 1 o 2 (en online se alterna entre jugadores)
    let player1Character = "";
    let player2Character = "";
    let turnActions = { 1: null, 2: null };
    let gameOver = false;
    let iaExperience = 0;
    let botDefensiveBias = 0;
    const initialHealth = 3;
    let player1 = null;
    let player2 = null;
    let difficulty = "medium";

    // Variables para modo online
    let socket = null;
    let roomId = null;
    let nickname = "";
    let opponentNickname = "";
    let playerIndex = 1;  // Se asigna por el servidor (1 o 2)

    // Música de fondo
    const bgMusic = new Audio();
    bgMusic.loop = true;
    window.addEventListener('load', () => { playMusic("background_inicio.mp3"); });
    function playMusic(src) {
      bgMusic.pause();
      bgMusic.src = src;
      bgMusic.load();
      bgMusic.play().catch(err => console.log("Autoplay bloqueado:", err));
    }
    function updateBackgroundMusic(viewId) {
      if (viewId === 'main-menu') {
        playMusic("background_inicio.mp3");
      } else if (viewId === 'character-selection') {
        if (!bgMusic.src.includes("background_inicio.mp3"))
          playMusic("background_inicio.mp3");
      } else if (viewId === 'combat') {
        const tracks = ["background_combat1.mp3", "background_combat2.mp3", "background_combat3.mp3"];
        playMusic(tracks[Math.floor(Math.random() * tracks.length)]);
      } else if (viewId === 'result') {
        bgMusic.pause();
      }
    }
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      updateBackgroundMusic(viewId);
    }

    /*************************************
     * MODALES: PERSONAJE Y GUÍA
     *************************************/
    let currentModalCharacter = "";
    function showCharacterModal(name) {
      const char = characters[name];
      currentModalCharacter = name;
      document.getElementById('modal-character-name').textContent = name;
      document.getElementById('modal-character-img').src = char.image;
      document.getElementById('modal-character-desc').textContent = char.description || "Sin detalles disponibles.";
      document.getElementById('character-modal').style.display = 'block';
    }
    function hideCharacterModal() {
      document.getElementById('character-modal').style.display = 'none';
    }
    function confirmCharacterSelection() {
      hideCharacterModal();
      selectCharacterConfirmed(currentModalCharacter);
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-confirm-character').addEventListener('click', confirmCharacterSelection);
      document.getElementById('btn-cancel-character').addEventListener('click', hideCharacterModal);
    });
    document.getElementById('btn-guide').addEventListener('click', () => {
      document.getElementById('guide-modal').style.display = 'block';
    });
    document.getElementById('btn-close-guide').addEventListener('click', () => {
      document.getElementById('guide-modal').style.display = 'none';
    });

    /*************************************
     * MENÚ PRINCIPAL
     *************************************/
    document.getElementById('btn-vs-ai').addEventListener('click', () => {
      gameMode = "vs_ai";
      currentPlayer = 1;
      difficulty = prompt("Nivel de dificultad (easy, medium, hard):", "medium") || "medium";
      showCharacterSelection();
    });
    document.getElementById('btn-duel').addEventListener('click', () => {
      gameMode = "duel";
      currentPlayer = 1;
      showCharacterSelection();
    });
    document.getElementById('btn-online').addEventListener('click', () => {
      gameMode = "online";
      nickname = prompt("Ingresa tu nickname para el modo online:");
      if (!nickname) return;
      // Obtener o generar el roomId
      const params = new URLSearchParams(window.location.search);
      roomId = params.get('room');
      if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 8);
        isHost = true;
        window.history.replaceState({}, '', window.location.pathname + '?room=' + roomId);
      } else {
        isHost = false;
      }
      // Conectar al servidor Socket.io (ajusta la URL a tu servidor)
      socket = io('http://localhost:3000');
      socket.emit('joinOnlineGame', { room: roomId, nickname });
      socket.on('roomFull', (data) => {
        alert(data.message);
        showView('main-menu');
      });
      socket.on('joinedRoom', (data) => {
        console.log("Te uniste a la sala:", data.room);
      });
      socket.on('roomReady', (data) => {
        alert(data.message); // "Dos jugadores en la sala. Elijan sus personajes."
        showCharacterSelection();
      });
      socket.on('onlineGameStarted', (data) => {
        playerIndex = data.playerIndex; // 1 o 2 asignado por el servidor
        opponentNickname = data.opponentNickname;
        player1Character = data.player1Char;
        player2Character = data.player2Char;
        startCombatOnline();
      });
      socket.on('receivePlayerAction', (data) => {
        if (data.nickname !== nickname) {
          // La acción del oponente se guarda en el índice opuesto
          let remoteIndex = (playerIndex === 1) ? 2 : 1;
          turnActions[remoteIndex] = { action: data.action, bulletsSpent: data.bulletsSpent };
          if (turnActions[playerIndex] && turnActions[remoteIndex]) {
            resolveTurnOnline();
          }
        }
      });
      showView('main-menu');
    });
    document.getElementById('btn-toggle-menu-music').addEventListener('click', function() {
      if (document.getElementById('main-menu').classList.contains('active')) {
        if (bgMusic.paused) { bgMusic.play(); this.textContent = "Pausar Música"; }
        else { bgMusic.pause(); this.textContent = "Reanudar Música"; }
      }
    });
    document.getElementById('btn-back-main').addEventListener('click', () => { showView('main-menu'); });
    document.getElementById('btn-return-menu').addEventListener('click', () => { showView('main-menu'); });

    /*************************************
     * SELECCIÓN DE PERSONAJES
     *************************************/
    function showCharacterSelection() {
      showView('character-selection');
      const header = document.getElementById('selection-header');
      header.textContent = (gameMode === "vs_ai" || gameMode === "online") ? "Selecciona tu Fumador" : (currentPlayer === 1 ? "Jugador 1: Selecciona tu Fumador" : "Jugador 2: Selecciona tu Fumador");
      const list = document.getElementById('character-list');
      list.innerHTML = "";
      for (let name in characters) {
        const card = document.createElement('div');
        card.classList.add('character-card');
        card.innerHTML = `<img src="${characters[name].image}" alt="${name}"><p>${name}</p>`;
        card.addEventListener('click', () => showCharacterModal(name));
        list.appendChild(card);
      }
    }
    function selectCharacterConfirmed(name) {
      if (gameMode === "vs_ai") {
        player1Character = name;
        let available = Object.keys(characters).filter(c => c !== name);
        player2Character = available[Math.floor(Math.random() * available.length)];
        startCombatLocal();
      } else if (gameMode === "duel") {
        if (currentPlayer === 1) {
          player1Character = name;
          currentPlayer = 2;
          showCharacterSelection();
        } else {
          player2Character = name;
          currentPlayer = 1;
          startCombatLocal();
        }
      } else if (gameMode === "online") {
        socket.emit('characterSelected', { room: roomId, nickname, character: name });
        // Se espera a que el servidor envíe 'onlineGameStarted'
        showView('main-menu');
      }
    }

    /*************************************
     * INICIAR COMBATE - MODO LOCAL
     *************************************/
    function startCombatLocal() {
      gameOver = false;
      if (gameMode === "vs_ai") iaExperience++;
      player1 = createPlayer(player1Character);
      player2 = createPlayer(player2Character);
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }

    /*************************************
     * INICIAR COMBATE - MODO ONLINE
     *************************************/
    function startCombatOnline() {
      gameOver = false;
      player1 = createPlayer(player1Character, nickname);
      player2 = createPlayer(player2Character, opponentNickname);
      turnActions = { 1: null, 2: null };
      currentPlayer = playerIndex;  // El turno inicial es el asignado al jugador local
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptionsOnline();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }

    /*************************************
     * OPCIONES DE COMBATE - MODO LOCAL
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let acts = [];
      if (current.bullets > 0) acts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
      if (current.character === "Amongolito") acts.push("sus");
      acts.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return; // Sólo una acción por turno
          if (current.character === "Kurt Cobain" && a === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: a, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * OPCIONES DE COMBATE - MODO ONLINE
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      // Mostrar opciones sólo si es tu turno (según playerIndex)
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let acts = [];
        if (current.bullets > 0) acts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
        if (current.character === "Amongolito") acts.push("sus");
        acts.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && a === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                return;
              }
            }
            turnActions[playerIndex] = { action: a, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: a, bulletsSpent: 1, playerIndex });
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * ENVÍO DE ACCIÓN (MODO LOCAL)
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }

    /*************************************
     * RESOLUCIÓN DE TURNOS (LOCAL y ONLINE)
     *************************************/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";

      // Descontar balas usadas (disparar o suicidarse)
      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);

      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);

      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;

      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }

      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        // Mostrar el resultado durante 3.5 segundos y luego volver al menú principal
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        // Si la partida continúa, reiniciar acciones y alternar turno
        turnActions = { 1: null, 2: null };
        if (gameMode === "online") {
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        } else {
          currentPlayer = 1;
        }
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          showCombatOptionsOnline();
        } else {
          showCombatOptions();
        }
        // Limpiar el mensaje de resolución después de 3.5 segundos
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
    }
    function handleSuicidesAndAmongolito(a1, a2) {
      let m = "";
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        if (a1 === "sus") m = `${player1.name} usó SUS y se protegió del suicidio de ${player2.name}. ¡Gana el turno!`;
        else { m = `${player2.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        if (a2 === "sus") m = `${player2.name} usó SUS y se protegió del suicidio de ${player1.name}. ¡Gana el turno!`;
        else { m = `${player1.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (a1 === "suicidarse" && a2 === "suicidarse") {
        m = "Ambos se suicidaron. ¡Empate!"; gameOver = true;
      } else if (a1 === "suicidarse" && a2 === "defender") {
        m = `${player1.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 === "defender") {
        m = `${player2.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a1 === "suicidarse" && a2 !== "defender") {
        m = `${player1.name} se suicidó y pierde. ${player2.name} gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 !== "defender") {
        m = `${player2.name} se suicidó y pierde. ${player1.name} gana.`; gameOver = true;
      }
      return m;
    }
    function handleShotsAndRecargas(a1, a2) {
      let m = "";
      if (a1 === "disparar") {
        if (a2 !== "defender") { player2.health--; m += `${player1.name} disparó y dañó a ${player2.name}. `; }
        else m += `${player1.name} disparó, pero ${player2.name} se defendió. `;
      }
      if (a2 === "disparar") {
        if (a1 !== "defender") { player1.health--; m += `${player2.name} disparó y dañó a ${player1.name}. `; }
        else m += `${player2.name} disparó, pero ${player1.name} se defendió. `;
      }
      if (a1 === "recargar") {
        if (player1.bullets < characters[player1.character].initialBullets) { player1.bullets++; m += `${player1.name} recargó y ganó una bala. `; }
      }
      if (a2 === "recargar") {
        if (player2.bullets < characters[player2.character].initialBullets) { player2.bullets++; m += `${player2.name} recargó y ganó una bala. `; }
      }
      if (a1 === "defender") m += `${player1.name} se defendió. `;
      if (a2 === "defender") m += `${player2.name} se defendió. `;
      return m;
    }
    function handleDeath(prevMsg) {
      let m = prevMsg;
      if (player1.health <= 0 && player2.health <= 0) m = "¡Ambos han caído! Empate.";
      else if (player1.health <= 0) m = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      else m = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      return m;
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        resolveTurn();
      }
    }

    /*************************************
     * BOT PARA LA IA (VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE (se activa desde socket)
     *************************************/
    // La función 'resolveTurnOnline()' se llama en el listener 'receivePlayerAction'
    
    /*************************************
     * PANTALLA DE RESULTADO (Auto-regreso al menú principal)
     *************************************/
    function showResult(msg) {
      document.getElementById('result-message').textContent = msg;
      showView('result');
      setTimeout(() => { showView('main-menu'); }, 3500);
    }

    /*************************************
     * OPCIONES DE COMBATE - MODO LOCAL
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let acts = [];
      if (current.bullets > 0) acts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
      if (current.character === "Amongolito") acts.push("sus");
      acts.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && a === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: a, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * OPCIONES DE COMBATE - MODO ONLINE
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let acts = [];
        if (current.bullets > 0) acts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
        if (current.character === "Amongolito") acts.push("sus");
        acts.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && a === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                return;
              }
            }
            turnActions[playerIndex] = { action: a, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: a, bulletsSpent: 1, playerIndex });
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * ENVÍO DE ACCIÓN (MODO LOCAL)
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }

    /*************************************
     * RESOLUCIÓN DE TURNOS (LOCAL y ONLINE)
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        resolveTurn();
      }
    }
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";

      // Descontar balas usadas en disparar o suicidarse
      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);

      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);

      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;

      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        // Mostrar el resultado final por 3.5 segundos y luego volver al menú principal
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online") {
          // Alternar turno entre 1 y 2
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        } else {
          currentPlayer = 1;
        }
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          showCombatOptionsOnline();
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
    }
    function handleSuicidesAndAmongolito(a1, a2) {
      let m = "";
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        if (a1 === "sus") m = `${player1.name} usó SUS y se protegió del suicidio de ${player2.name}. ¡Gana el turno!`;
        else { m = `${player2.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        if (a2 === "sus") m = `${player2.name} usó SUS y se protegió del suicidio de ${player1.name}. ¡Gana el turno!`;
        else { m = `${player1.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (a1 === "suicidarse" && a2 === "suicidarse") {
        m = "Ambos se suicidaron. ¡Empate!"; gameOver = true;
      } else if (a1 === "suicidarse" && a2 === "defender") {
        m = `${player1.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 === "defender") {
        m = `${player2.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a1 === "suicidarse" && a2 !== "defender") {
        m = `${player1.name} se suicidó y pierde. ${player2.name} gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 !== "defender") {
        m = `${player2.name} se suicidó y pierde. ${player1.name} gana.`; gameOver = true;
      }
      return m;
    }
    function handleShotsAndRecargas(a1, a2) {
      let m = "";
      if (a1 === "disparar") {
        if (a2 !== "defender") { player2.health--; m += `${player1.name} disparó y dañó a ${player2.name}. `; }
        else m += `${player1.name} disparó, pero ${player2.name} se defendió. `;
      }
      if (a2 === "disparar") {
        if (a1 !== "defender") { player1.health--; m += `${player2.name} disparó y dañó a ${player1.name}. `; }
        else m += `${player2.name} disparó, pero ${player1.name} se defendió. `;
      }
      if (a1 === "recargar") {
        if (player1.bullets < characters[player1.character].initialBullets) { player1.bullets++; m += `${player1.name} recargó y ganó una bala. `; }
      }
      if (a2 === "recargar") {
        if (player2.bullets < characters[player2.character].initialBullets) { player2.bullets++; m += `${player2.name} recargó y ganó una bala. `; }
      }
      if (a1 === "defender") m += `${player1.name} se defendió. `;
      if (a2 === "defender") m += `${player2.name} se defendió. `;
      return m;
    }
    function handleDeath(prevMsg) {
      let m = prevMsg;
      if (player1.health <= 0 && player2.health <= 0) m = "¡Ambos han caído! Empate.";
      else if (player1.health <= 0) m = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      else m = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      return m;
    }

    /*************************************
     * BOT PARA LA IA (Modo VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        resolveTurn();
      }
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Local
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let acts = [];
      if (current.bullets > 0) acts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
      if (current.character === "Amongolito") acts.push("sus");
      acts.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && a === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: a, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Online
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      // Mostrar opciones sólo si es el turno del jugador local
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let acts = [];
        if (current.bullets > 0) acts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
        if (current.character === "Amongolito") acts.push("sus");
        acts.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && a === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                return;
              }
            }
            turnActions[playerIndex] = { action: a, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: a, bulletsSpent: 1, playerIndex });
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * ENVÍO DE ACCIÓN - Modo Local
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }

    /*************************************
     * RESOLUCIÓN DE TURNOS (Local y Online)
     *************************************/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";

      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);

      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);

      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;

      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        // Mostrar el resultado final por 3.5 segundos y luego volver al menú principal automáticamente
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online") {
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        } else {
          currentPlayer = 1;
        }
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          showCombatOptionsOnline();
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
    }
    function handleSuicidesAndAmongolito(a1, a2) {
      let m = "";
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        if (a1 === "sus") m = `${player1.name} usó SUS y se protegió del suicidio de ${player2.name}. ¡Gana el turno!`;
        else { m = `${player2.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        if (a2 === "sus") m = `${player2.name} usó SUS y se protegió del suicidio de ${player1.name}. ¡Gana el turno!`;
        else { m = `${player1.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (a1 === "suicidarse" && a2 === "suicidarse") {
        m = "Ambos se suicidaron. ¡Empate!"; gameOver = true;
      } else if (a1 === "suicidarse" && a2 === "defender") {
        m = `${player1.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 === "defender") {
        m = `${player2.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a1 === "suicidarse" && a2 !== "defender") {
        m = `${player1.name} se suicidó y pierde. ${player2.name} gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 !== "defender") {
        m = `${player2.name} se suicidó y pierde. ${player1.name} gana.`; gameOver = true;
      }
      return m;
    }
    function handleShotsAndRecargas(a1, a2) {
      let m = "";
      if (a1 === "disparar") {
        if (a2 !== "defender") { player2.health--; m += `${player1.name} disparó y dañó a ${player2.name}. `; }
        else m += `${player1.name} disparó, pero ${player2.name} se defendió. `;
      }
      if (a2 === "disparar") {
        if (a1 !== "defender") { player1.health--; m += `${player2.name} disparó y dañó a ${player1.name}. `; }
        else m += `${player2.name} disparó, pero ${player1.name} se defendió. `;
      }
      if (a1 === "recargar") {
        if (player1.bullets < characters[player1.character].initialBullets) { player1.bullets++; m += `${player1.name} recargó y ganó una bala. `; }
      }
      if (a2 === "recargar") {
        if (player2.bullets < characters[player2.character].initialBullets) { player2.bullets++; m += `${player2.name} recargó y ganó una bala. `; }
      }
      if (a1 === "defender") m += `${player1.name} se defendió. `;
      if (a2 === "defender") m += `${player2.name} se defendió. `;
      return m;
    }
    function handleDeath(prevMsg) {
      let m = prevMsg;
      if (player1.health <= 0 && player2.health <= 0) m = "¡Ambos han caído! Empate.";
      else if (player1.health <= 0) m = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      else m = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      return m;
    }

    /*************************************
     * BOT PARA LA IA (Modo VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        resolveTurn();
      }
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Local
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let acts = [];
      if (current.bullets > 0) acts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
      if (current.character === "Amongolito") acts.push("sus");
      acts.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && a === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: a, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Online
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let acts = [];
        if (current.bullets > 0) acts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
        if (current.character === "Amongolito") acts.push("sus");
        acts.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && a === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                return;
              }
            }
            turnActions[playerIndex] = { action: a, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: a, bulletsSpent: 1, playerIndex });
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * ENVÍO DE ACCIÓN - Modo Local
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }

    /*************************************
     * RESOLUCIÓN DE TURNOS (Local y Online)
     *************************************/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";

      // Descontar balas usadas en disparar o suicidarse
      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);

      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);

      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;

      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        // Mostrar el resultado final durante 3.5 s y luego regresar al menú principal
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online") {
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        } else {
          currentPlayer = 1;
        }
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          showCombatOptionsOnline();
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
    }
    function handleSuicidesAndAmongolito(a1, a2) {
      let m = "";
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        if (a1 === "sus") m = `${player1.name} usó SUS y se protegió del suicidio de ${player2.name}. ¡Gana el turno!`;
        else { m = `${player2.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        if (a2 === "sus") m = `${player2.name} usó SUS y se protegió del suicidio de ${player1.name}. ¡Gana el turno!`;
        else { m = `${player1.name} gana, porque Amongolito se asustó y murió al ver el suicidio.`; gameOver = true; }
      } else if (a1 === "suicidarse" && a2 === "suicidarse") {
        m = "Ambos se suicidaron. ¡Empate!"; gameOver = true;
      } else if (a1 === "suicidarse" && a2 === "defender") {
        m = `${player1.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 === "defender") {
        m = `${player2.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a1 === "suicidarse" && a2 !== "defender") {
        m = `${player1.name} se suicidó y pierde. ${player2.name} gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 !== "defender") {
        m = `${player2.name} se suicidó y pierde. ${player1.name} gana.`; gameOver = true;
      }
      return m;
    }
    function handleShotsAndRecargas(a1, a2) {
      let m = "";
      if (a1 === "disparar") {
        if (a2 !== "defender") { player2.health--; m += `${player1.name} disparó y dañó a ${player2.name}. `; }
        else m += `${player1.name} disparó, pero ${player2.name} se defendió. `;
      }
      if (a2 === "disparar") {
        if (a1 !== "defender") { player1.health--; m += `${player2.name} disparó y dañó a ${player1.name}. `; }
        else m += `${player2.name} disparó, pero ${player1.name} se defendió. `;
      }
      if (a1 === "recargar") {
        if (player1.bullets < characters[player1.character].initialBullets) { player1.bullets++; m += `${player1.name} recargó y ganó una bala. `; }
      }
      if (a2 === "recargar") {
        if (player2.bullets < characters[player2.character].initialBullets) { player2.bullets++; m += `${player2.name} recargó y ganó una bala. `; }
      }
      if (a1 === "defender") m += `${player1.name} se defendió. `;
      if (a2 === "defender") m += `${player2.name} se defendió. `;
      return m;
    }
    function handleDeath(prevMsg) {
      let m = prevMsg;
      if (player1.health <= 0 && player2.health <= 0) m = "¡Ambos han caído! Empate.";
      else if (player1.health <= 0) m = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      else m = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      return m;
    }

    /*************************************
     * BOT PARA LA IA (Modo VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) resolveTurn();
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Local
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let acts = [];
      if (current.bullets > 0) acts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
      if (current.character === "Amongolito") acts.push("sus");
      acts.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && a === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: a, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Online
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let acts = [];
        if (current.bullets > 0) acts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
        if (current.character === "Amongolito") acts.push("sus");
        acts.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && a === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                return;
              }
            }
            turnActions[playerIndex] = { action: a, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: a, bulletsSpent: 1, playerIndex });
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * ENVÍO DE ACCIÓN - Modo Local
     *************************************/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }

    /*************************************
     * RESOLUCIÓN DE TURNOS (Local y Online)
     *************************************/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";

      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);

      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);

      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;

      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        // Después de 3.5 s se muestra el resultado y se vuelve al menú principal
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online") {
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        } else {
          currentPlayer = 1;
        }
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          showCombatOptionsOnline();
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
    }
    function handleDeath(prevMsg) {
      let m = prevMsg;
      if (player1.health <= 0 && player2.health <= 0) m = "¡Ambos han caído! Empate.";
      else if (player1.health <= 0) m = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      else m = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      return m;
    }

    /*************************************
     * BOT PARA LA IA (Modo VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE
     *************************************/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) resolveTurn();
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Local
     *************************************/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let acts = [];
      if (current.bullets > 0) acts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
      if (current.character === "Amongolito") acts.push("sus");
      acts.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && a === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: a, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }

    /*************************************
     * OPCIONES DE COMBATE - Modo Online
     *************************************/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let acts = [];
        if (current.bullets > 0) acts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") acts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) acts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") acts.push("defender");
        if (current.character === "Amongolito") acts.push("sus");
        acts.forEach(a => {
          const btn = document.createElement('button');
          btn.textContent = a.charAt(0).toUpperCase() + a.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && a === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                return;
              }
            }
            turnActions[playerIndex] = { action: a, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: a, bulletsSpent: 1, playerIndex });
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }

    /*************************************
     * ENVÍO DE ACCIÓN - Modo Local
     *************************************/
    // Para modos locales se utiliza submitAction() (ya definida arriba)

    /*************************************
     * RESOLUCIÓN DEL TURNO ONLINE
     *************************************/
    // Se llama a resolveTurnOnline() desde el listener de 'receivePlayerAction' (ya definido)

    /*************************************
     * PANTALLA DE RESULTADO (Auto-regreso al menú principal)
     *************************************/
    function showResult(msg) {
      document.getElementById('result-message').textContent = msg;
      showView('result');
      setTimeout(() => { showView('main-menu'); }, 3500);
    }

    /*************************************
     * BOT PARA LA IA (Modo VS IA)
     *************************************/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }

    /*************************************
     * FUNCIONES PARA INICIAR COMBATE
     *************************************/
    // Modo local (VS IA o Duelo)
    function startCombatLocal() {
      gameOver = false;
      if (gameMode === "vs_ai") iaExperience++;
      player1 = createPlayer(player1Character);
      player2 = createPlayer(player2Character);
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    // Modo online
    function startCombatOnline() {
      gameOver = false;
      player1 = createPlayer(player1Character, nickname);
      player2 = createPlayer(player2Character, opponentNickname);
      turnActions = { 1: null, 2: null };
      currentPlayer = playerIndex; // El turno inicial es el asignado al jugador local
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptionsOnline();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }

    /*************************************
     * ACTUALIZAR INFORMACIÓN DEL TURNO
     *************************************/
    function updateCurrentTurnInfo() {
      const current = (currentPlayer === 1) ? player1 : player2;
      document.getElementById('turn-header').textContent = "TURNO DE " + current.name;
      document.getElementById('current-turn-img').src = characters[current.character].image;
      document.getElementById('current-turn-info').textContent = `Balas: ${current.bullets} | Health: ${current.health}`;
      if (current.character === "El Xokas") {
        updatePrediction();
      } else {
        document.getElementById('prediction').textContent = "";
      }
    }
    /*************************************
     * ACTUALIZAR SCOREBOARD
     *************************************/
    function updateScoreboard() {
      document.getElementById('player1-name').textContent = player1.name;
      document.getElementById('player1-health').textContent = player1.health;
      document.getElementById('player1-bullets').textContent = player1.bullets;
      document.getElementById('player2-name').textContent = player2.name;
      document.getElementById('player2-health').textContent = player2.health;
      document.getElementById('player2-bullets').textContent = player2.bullets;
    }

    /*************************************
     * CONTROL DE VOLUMEN
     *************************************/
    document.getElementById('volume-slider').addEventListener('input', function() {
      bgMusic.volume = parseFloat(this.value);
    });
  </script>
  <script>
    // Crear el slider si no existe
    if (!document.getElementById('volume-slider')) {
      const vc = document.createElement('div');
      vc.id = "volume-control";
      vc.innerHTML = `<label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">`;
      document.getElementById('main-menu').appendChild(vc);
    }
  </script>
</body>
</html>


