<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <!-- Todas las rutas relativas se resuelven desde esta carpeta -->
  <base href="./">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Desert Gold</title>
  
  <!-- Cargar Socket.io (sólo se usa en modo online) -->
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  
  <style>
    /* RESET y estilos básicos */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; background-color: #222; color: #eee; line-height: 1.5; }
    #app { max-width: 800px; margin: 0 auto; padding: 1rem; }
    .view { display: none; }
    .active { display: block; }
    h1, h2 { text-align: center; margin-bottom: 1rem; }
    button {
      padding: 0.75rem 1.5rem; margin: 0.5rem; font-size: 1rem;
      border: none; border-radius: 5px; background-color: #555; color: #eee; cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #777; }
    /* Botón fijo para GUÍA (esquina inferior izquierda) */
    #btn-guide {
      position: fixed; bottom: 20px; left: 20px; z-index: 2000; background-color: #444;
    }
    /* CARTAS DE PERSONAJES */
    .character-card {
      display: inline-block; width: 150px; margin: 10px; text-align: center;
      cursor: pointer; border: 1px solid #555; border-radius: 8px;
      overflow: hidden; background-color: #333; transition: transform 0.2s;
    }
    .character-card:hover { transform: scale(1.05); }
    .character-card img { width: 100%; height: auto; }
    .character-card p { margin: 0.5rem; }
    /* VISTAS: MENÚ, SELECCIÓN, COMBATE, RESULTADO */
    #main-menu, #character-selection, #combat, #result { text-align: center; padding: 1rem; }
    /* SCOREBOARD */
    #scoreboard {
      display: flex; justify-content: space-around; margin-bottom: 1rem; font-weight: bold;
    }
    #scoreboard div { text-align: center; }
    /* INFORMACIÓN DEL TURNO */
    #current-turn { text-align: center; margin-bottom: 1rem; }
    #current-turn img {
      max-width: 200px; border: 3px solid #555; border-radius: 50%; margin: 0 auto; display: block;
    }
    #action-buttons { text-align: center; margin: 1rem 0; }
    #combat-result { text-align: center; margin: 0.5rem 0; font-style: italic; }
    /* PREDICCIÓN (El Xokas) */
    #prediction { text-align: center; margin-bottom: 1rem; font-style: italic; color: #ccc; }
    /* CONTROL DE VOLUMEN */
    #volume-control { text-align: center; margin-top: 1rem; }
    #volume-control label { margin-right: 0.5rem; }
    /* MODALES (para Personaje y Guía) */
    .modal {
      display: none; position: fixed; z-index: 1500; left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background-color: #333; margin: 10% auto; padding: 20px;
      border: 1px solid #555; width: 90%; max-width: 500px;
      border-radius: 8px; text-align: left; color: #eee;
    }
    .modal-content h2 { text-align: center; }
    .modal-content p { margin: 0.5rem 0; }
    .modal-buttons { margin-top: 1rem; text-align: center; }
    .modal-buttons button { margin: 0.5rem; }
    /* MEDIA QUERIES */
    @media (max-width: 600px) {
      button { font-size: 0.9rem; padding: 0.5rem 1rem; }
      h1 { font-size: 1.75rem; }
      h2 { font-size: 1.25rem; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- MENÚ PRINCIPAL -->
    <div id="main-menu" class="view active">
      <h1>Desert Gold</h1>
      <h2>El Tabaco</h2>
      <button id="btn-vs-ai">Combate VS IA</button>
      <button id="btn-duel">Duelo Local</button>
      <button id="btn-online">CIGARROS ELECTRÓNICOS (Online)</button>
      <button id="btn-toggle-menu-music">Pausar Música</button>
      <div id="volume-control">
        <label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>
    
    <!-- SELECCIÓN DE PERSONAJES -->
    <div id="character-selection" class="view">
      <h2 id="selection-header">Selecciona tu Fumador</h2>
      <div id="character-list"></div>
      <button id="btn-back-main">Volver al Menú Principal</button>
    </div>
    
    <!-- PANTALLA DE COMBATE -->
    <div id="combat" class="view">
      <div id="scoreboard">
        <div id="player1-score">
          <span id="player1-name">Jugador 1</span><br>
          Health: <span id="player1-health">3</span><br>
          Balas: <span id="player1-bullets">0</span>
        </div>
        <div id="player2-score">
          <span id="player2-name">Jugador 2</span><br>
          Health: <span id="player2-health">3</span><br>
          Balas: <span id="player2-bullets">0</span>
        </div>
      </div>
      <div id="current-turn">
        <h2 id="turn-header">TURNO DE</h2>
        <img id="current-turn-img" src="" alt="Jugador Actual">
        <p id="current-turn-info"></p>
        <p id="prediction"></p>
      </div>
      <div id="action-buttons"></div>
      <div id="combat-result"></div>
    </div>
    
    <!-- PANTALLA DE RESULTADO (Se muestra el mensaje final durante 3.5 s y luego se regresa al menú) -->
    <div id="result" class="view">
      <h2 id="result-message"></h2>
    </div>
  </div>
  
  <!-- MODAL PARA PERSONAJE -->
  <div id="character-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-character-name"></h2>
      <img id="modal-character-img" src="" alt="Imagen del personaje">
      <p id="modal-character-desc"></p>
      <div class="modal-buttons">
        <button id="btn-confirm-character">Seleccionar</button>
        <button id="btn-cancel-character">Cancelar</button>
      </div>
    </div>
  </div>
  
  <!-- MODAL PARA GUÍA -->
  <div id="guide-modal" class="modal">
    <div class="modal-content">
      <h2>Guía de Juego - Desert Gold</h2>
      <p><strong>Introducción:</strong> Bienvenido a <em>Desert Gold</em>, un juego de estrategia en el que puedes enfrentarte a la IA, jugar en duelo local o competir online (modo <em>CIGARROS ELECTRÓNICOS</em>).</p>
      <p><strong>Modos:</strong></p>
      <ul>
        <li><strong>VS IA:</strong> La IA aprende con cada combate.</li>
        <li><strong>Duelo Local:</strong> Dos jugadores se turnan en la misma máquina.</li>
        <li><strong>Online:</strong> Ingresa tu nickname y comparte el enlace de la sala para competir.</li>
      </ul>
      <p><strong>Personajes:</strong></p>
      <ul>
        <li><strong>Pepe:</strong> Equilibrado y sencillo.</li>
        <li><strong>Manueh:</strong> Más balas, pero no puede usar “defender”.</li>
        <li><strong>Kurt Cobain:</strong> Cada disparo aumenta su probabilidad de suicidio un 25%.</li>
        <li><strong>El Xokas:</strong> Alta probabilidad de predecir la acción rival.</li>
        <li><strong>Rajoy:</strong> Muy resistente, pero con pocas balas.</li>
        <li><strong>Amongolito:</strong> No puede suicidarse; dispone de la acción “sus” para protegerse.</li>
      </ul>
      <p><strong>Mecánica:</strong> Cada turno, el jugador activo elige entre disparar, recargar, defender (no disponible para Manueh), suicidarse (no para Amongolito) o “sus” (sólo Amongolito). El objetivo es reducir la salud del oponente a 0 o provocar su suicidio.</p>
      <div class="modal-buttons">
        <button id="btn-close-guide">Cerrar Guía</button>
      </div>
    </div>
  </div>
  
  <!-- Botón fijo para GUÍA -->
  <button id="btn-guide">GUÍA</button>
  
  <script>
    /********** VARIABLES GLOBALES y DATOS de PERSONAJES **********/
    const characters = {
      "Pepe": { image: "pepe.png", initialBullets: 2, description: "Equilibrado y sencillo." },
      "Manueh": { image: "manueh.png", initialBullets: 3, description: "Más balas, pero no puede defender." },
      "Kurt Cobain": { image: "kurtcobain.png", initialBullets: 4, suicideChance: 0.25, description: "Cada disparo aumenta su probabilidad de suicidio un 25%." },
      "El Xokas": { image: "xokas.png", initialBullets: 1, predictChance: 1, description: "Alta probabilidad de predecir la acción rival." },
      "Rajoy": { image: "rajoy.png", initialBullets: 1, description: "Muy resistente, pocas balas." },
      "Amongolito": { image: "amongolito.png", initialBullets: 2, description: "No puede suicidarse; dispone de la acción 'sus'." }
    };
    
    let gameMode = "";         // "vs_ai", "duel", "online"
    let currentPlayer = 1;       // En local: 1 o 2; en online se alterna según se asigne
    let player1Character = "";
    let player2Character = "";
    let turnActions = { 1: null, 2: null };
    let gameOver = false;
    const initialHealth = 3;
    let player1 = null;
    let player2 = null;
    let difficulty = "medium";
    let iaExperience = 0;
    let botDefensiveBias = 0;
    
    // Variables para modo online
    let socket = null;
    let roomId = null;
    let nickname = "";
    let opponentNickname = "";
    let playerIndex = 1;  // Asignado por el servidor: 1 (host) o 2
    
    // Música de fondo
    const bgMusic = new Audio();
    bgMusic.loop = true;
    window.addEventListener('load', () => { playMusic("background_inicio.mp3"); });
    function playMusic(src) {
      bgMusic.pause();
      bgMusic.src = src;
      bgMusic.load();
      bgMusic.play().catch(err => console.log("Autoplay bloqueado:", err));
    }
    function updateBackgroundMusic(viewId) {
      if (viewId === 'main-menu') {
        playMusic("background_inicio.mp3");
      } else if (viewId === 'character-selection') {
        if (!bgMusic.src.includes("background_inicio.mp3"))
          playMusic("background_inicio.mp3");
      } else if (viewId === 'combat') {
        const tracks = ["background_combat1.mp3", "background_combat2.mp3", "background_combat3.mp3"];
        playMusic(tracks[Math.floor(Math.random() * tracks.length)]);
      } else if (viewId === 'result') {
        bgMusic.pause();
      }
    }
    function showView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      updateBackgroundMusic(viewId);
    }
    
    // Función para crear jugador (opcional: asigna nombre personalizado en online)
    function createPlayer(characterName, customName) {
      return {
        name: customName || characterName,
        character: characterName,
        bullets: characters[characterName].initialBullets,
        health: initialHealth,
        defenseActive: false,
        lastAction: null,
        currentSuicideChance: (characterName === "Kurt Cobain") ? 0.25 : 0
      };
    }
    
    /********** MODALES: PERSONAJE y GUÍA **********/
    let currentModalCharacter = "";
    function showCharacterModal(name) {
      const char = characters[name];
      currentModalCharacter = name;
      document.getElementById('modal-character-name').textContent = name;
      document.getElementById('modal-character-img').src = char.image;
      document.getElementById('modal-character-desc').textContent = char.description;
      document.getElementById('character-modal').style.display = 'block';
    }
    function hideCharacterModal() {
      document.getElementById('character-modal').style.display = 'none';
    }
    function confirmCharacterSelection() {
      hideCharacterModal();
      selectCharacterConfirmed(currentModalCharacter);
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btn-confirm-character').addEventListener('click', confirmCharacterSelection);
      document.getElementById('btn-cancel-character').addEventListener('click', hideCharacterModal);
    });
    document.getElementById('btn-guide').addEventListener('click', () => {
      document.getElementById('guide-modal').style.display = 'block';
    });
    document.getElementById('btn-close-guide').addEventListener('click', () => {
      document.getElementById('guide-modal').style.display = 'none';
    });
    
    /********** MENÚ PRINCIPAL **********/
    document.getElementById('btn-vs-ai').addEventListener('click', () => {
      gameMode = "vs_ai";
      currentPlayer = 1;
      difficulty = prompt("Nivel de dificultad (easy, medium, hard):", "medium") || "medium";
      showCharacterSelection();
    });
    document.getElementById('btn-duel').addEventListener('click', () => {
      gameMode = "duel";
      currentPlayer = 1;
      showCharacterSelection();
    });
    document.getElementById('btn-online').addEventListener('click', () => {
      gameMode = "online";
      nickname = prompt("Ingresa tu nickname para el modo online:");
      if (!nickname) return;
      const params = new URLSearchParams(window.location.search);
      roomId = params.get('room');
      if (!roomId) {
        roomId = Math.random().toString(36).substring(2, 8);
        playerIndex = 1;  // Primer jugador (host)
        window.history.replaceState({}, '', window.location.pathname + '?room=' + roomId);
      } else {
        playerIndex = 2;  // Segundo jugador
      }
      socket = io('http://localhost:3000');
      socket.emit('joinOnlineGame', { room: roomId, nickname });
      socket.on('roomFull', (data) => {
        alert(data.message);
        showView('main-menu');
      });
      socket.on('joinedRoom', (data) => {
        console.log("Te uniste a la sala:", data.room);
      });
      socket.on('roomReady', (data) => {
        alert(data.message);
        showCharacterSelection();
      });
      socket.on('onlineGameStarted', (data) => {
        // El servidor asigna los personajes y el turno
        playerIndex = data.playerIndex;
        opponentNickname = data.opponentNickname;
        player1Character = data.player1Char;
        player2Character = data.player2Char;
        startCombatOnline();
      });
      // Aquí se recibe el resultado del turno resuelto por el host
      socket.on('turnResolved', (data) => {
        // Actualiza la interfaz con el resultado recibido
        document.getElementById('combat-result').textContent = data.outcome;
        currentPlayer = data.nextTurn;
        // Reinicia las acciones para el siguiente turno
        turnActions = { 1: null, 2: null };
        // Después de 3.5 segundos, se limpia el mensaje y se actualiza la UI según el turno
        setTimeout(() => {
          document.getElementById('combat-result').textContent = "";
          updateCurrentTurnInfo();
          if (playerIndex === currentPlayer) {
            showCombatOptionsOnline();
          } else {
            document.getElementById('action-buttons').textContent = "Esperando acción del oponente...";
          }
        }, 3500);
      });
      showView('main-menu');
    });
    document.getElementById('btn-toggle-menu-music').addEventListener('click', function() {
      if (document.getElementById('main-menu').classList.contains('active')) {
        if (bgMusic.paused) { bgMusic.play(); this.textContent = "Pausar Música"; }
        else { bgMusic.pause(); this.textContent = "Reanudar Música"; }
      }
    });
    document.getElementById('btn-back-main').addEventListener('click', () => { showView('main-menu'); });
    document.getElementById('btn-return-menu').addEventListener('click', () => { showView('main-menu'); });
    
    /********** SELECCIÓN DE PERSONAJES **********/
    function showCharacterSelection() {
      showView('character-selection');
      const header = document.getElementById('selection-header');
      header.textContent = (gameMode === "vs_ai" || gameMode === "online")
        ? "Selecciona tu Fumador"
        : (currentPlayer === 1 ? "Jugador 1: Selecciona tu Fumador" : "Jugador 2: Selecciona tu Fumador");
      const list = document.getElementById('character-list');
      list.innerHTML = "";
      for (let name in characters) {
        const card = document.createElement('div');
        card.classList.add('character-card');
        card.innerHTML = `<img src="${characters[name].image}" alt="${name}"><p>${name}</p>`;
        card.addEventListener('click', () => showCharacterModal(name));
        list.appendChild(card);
      }
    }
    function selectCharacterConfirmed(name) {
      if (gameMode === "vs_ai") {
        player1Character = name;
        let available = Object.keys(characters).filter(c => c !== name);
        player2Character = available[Math.floor(Math.random() * available.length)];
        startCombatLocal();
      } else if (gameMode === "duel") {
        if (currentPlayer === 1) {
          player1Character = name;
          currentPlayer = 2;
          showCharacterSelection();
        } else {
          player2Character = name;
          currentPlayer = 1;
          startCombatLocal();
        }
      } else if (gameMode === "online") {
        socket.emit('characterSelected', { room: roomId, nickname, character: name });
        showView('main-menu');
      }
    }
    
    /********** INICIAR COMBATE **********/
    // Modo local (VS IA y Duelo)
    function startCombatLocal() {
      gameOver = false;
      if (gameMode === "vs_ai") iaExperience++;
      player1 = createPlayer(player1Character);
      player2 = createPlayer(player2Character);
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    // Modo online
    function startCombatOnline() {
      gameOver = false;
      player1 = createPlayer(player1Character, nickname);
      player2 = createPlayer(player2Character, opponentNickname);
      turnActions = { 1: null, 2: null };
      // El turno inicial lo asigna el servidor (playerIndex)
      currentPlayer = playerIndex;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptionsOnline();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    
    /********** ACTUALIZAR UI: SCOREBOARD y TURNO **********/
    function updateScoreboard() {
      document.getElementById('player1-name').textContent = player1.name;
      document.getElementById('player1-health').textContent = player1.health;
      document.getElementById('player1-bullets').textContent = player1.bullets;
      document.getElementById('player2-name').textContent = player2.name;
      document.getElementById('player2-health').textContent = player2.health;
      document.getElementById('player2-bullets').textContent = player2.bullets;
    }
    function updateCurrentTurnInfo() {
      const current = (currentPlayer === 1) ? player1 : player2;
      document.getElementById('turn-header').textContent = "TURNO DE " + current.name;
      document.getElementById('current-turn-img').src = characters[current.character].image;
      document.getElementById('current-turn-info').textContent = `Balas: ${current.bullets} | Health: ${current.health}`;
      if (current.character === "El Xokas") updatePrediction();
      else document.getElementById('prediction').textContent = "";
    }
    function updatePrediction() {
      const predictionEl = document.getElementById('prediction');
      const opponent = (currentPlayer === 1) ? player2 : player1;
      let allowed = [];
      if (opponent.bullets > 0) allowed.push("disparar");
      if (opponent.bullets < characters[opponent.character].initialBullets) allowed.push("recargar");
      if (opponent.lastAction !== "defender") allowed.push("defender");
      predictionEl.textContent = allowed.length ? "El Xokas predice: " + allowed[Math.floor(Math.random() * allowed.length)] : "Sin acciones para predecir.";
    }
    
    /********** OPCIONES DE COMBATE - Modo Local **********/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let opts = [];
      if (current.bullets > 0) opts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") opts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) opts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") opts.push("defender");
      if (current.character === "Amongolito") opts.push("sus");
      opts.forEach(op => {
        const btn = document.createElement('button');
        btn.textContent = op.charAt(0).toUpperCase() + op.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return; // Limita a 1 acción por turno
          if (current.character === "Kurt Cobain" && op === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: op, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }
    
    /********** OPCIONES DE COMBATE - Modo Online **********/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      // Mostrar botones solo si es tu turno según playerIndex
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let opts = [];
        if (current.bullets > 0) opts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") opts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) opts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") opts.push("defender");
        if (current.character === "Amongolito") opts.push("sus");
        opts.forEach(op => {
          const btn = document.createElement('button');
          btn.textContent = op.charAt(0).toUpperCase() + op.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            // Lógica especial para Kurt Cobain
            if (current.character === "Kurt Cobain" && op === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                // Llama a resolveTurnOnline inmediatamente
                resolveTurnOnline();
                return;
              }
            }
            turnActions[playerIndex] = { action: op, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: op, bulletsSpent: 1, playerIndex });
            resolveTurnOnline();
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }
    
    /********** ENVÍO DE ACCIÓN - Modo Local **********/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }
    
    /********** RESOLUCIÓN DE TURNOS (Local y Online) **********/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";
      
      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);
      
      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);
      
      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;
      
      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      // En modo online, el host (playerIndex 1) resuelve y emite el resultado
      if (gameMode === "online" && playerIndex === 1) {
        // Alternar turno: si el turno actual es 1, el siguiente es 2, y viceversa
        currentPlayer = (currentPlayer === 1) ? 2 : 1;
        socket.emit('turnResolved', { room: roomId, outcome: outcomeMsg, nextTurn: currentPlayer });
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online")
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        else
          currentPlayer = 1;
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          if (playerIndex === currentPlayer) {
            showCombatOptionsOnline();
          } else {
            document.getElementById('action-buttons').textContent = "Esperando acción del oponente...";
          }
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
      return outcomeMsg; // Para que el host pueda emitir el resultado
    }
    
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        if (playerIndex === 1) {
          // El host resuelve y emite el resultado
          resolveTurn();
        }
      }
    }
    
    function handleDeath(prevMsg) {
      let m = prevMsg;
      if (player1.health <= 0 && player2.health <= 0) m = "¡Ambos han caído! Empate.";
      else if (player1.health <= 0) m = `${player2.name} gana, ¡${player1.name} ha sido derrotado!`;
      else m = `${player1.name} gana, ¡${player2.name} ha sido derrotado!`;
      return m;
    }
    
    function handleSuicidesAndAmongolito(a1, a2) {
      let m = "";
      if (player1.character === "Amongolito" && a2 === "suicidarse") {
        if (a1 === "sus") m = `${player1.name} usó SUS y se protegió del suicidio de ${player2.name}.`;
        else { m = `${player2.name} gana, porque Amongolito se asustó y murió.`; gameOver = true; }
      } else if (player2.character === "Amongolito" && a1 === "suicidarse") {
        if (a2 === "sus") m = `${player2.name} usó SUS y se protegió del suicidio de ${player1.name}.`;
        else { m = `${player1.name} gana, porque Amongolito se asustó y murió.`; gameOver = true; }
      } else if (a1 === "suicidarse" && a2 === "suicidarse") {
        m = "Ambos se suicidaron. ¡Empate!"; gameOver = true;
      } else if (a1 === "suicidarse" && a2 === "defender") {
        m = `${player1.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 === "defender") {
        m = `${player2.name} se suicidó contra la defensa y gana.`; gameOver = true;
      } else if (a1 === "suicidarse" && a2 !== "defender") {
        m = `${player1.name} se suicidó y pierde. ${player2.name} gana.`; gameOver = true;
      } else if (a2 === "suicidarse" && a1 !== "defender") {
        m = `${player2.name} se suicidó y pierde. ${player1.name} gana.`; gameOver = true;
      }
      return m;
    }
    
    function handleShotsAndRecargas(a1, a2) {
      let m = "";
      if (a1 === "disparar") {
        if (a2 !== "defender") { player2.health--; m += `${player1.name} disparó y dañó a ${player2.name}. `; }
        else m += `${player1.name} disparó, pero ${player2.name} se defendió. `;
      }
      if (a2 === "disparar") {
        if (a1 !== "defender") { player1.health--; m += `${player2.name} disparó y dañó a ${player1.name}. `; }
        else m += `${player2.name} disparó, pero ${player1.name} se defendió. `;
      }
      if (a1 === "recargar") {
        if (player1.bullets < characters[player1.character].initialBullets) { player1.bullets++; m += `${player1.name} recargó y ganó una bala. `; }
      }
      if (a2 === "recargar") {
        if (player2.bullets < characters[player2.character].initialBullets) { player2.bullets++; m += `${player2.name} recargó y ganó una bala. `; }
      }
      if (a1 === "defender") m += `${player1.name} se defendió. `;
      if (a2 === "defender") m += `${player2.name} se defendió. `;
      return m;
    }
    
    /********** BOT PARA LA IA (Modo VS IA) **********/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }
    
    /********** RESOLUCIÓN DEL TURNO ONLINE **********/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        // Solo el host (playerIndex 1) resolverá el turno y emitirá el resultado
        if (playerIndex === 1) {
          let outcome = resolveTurn();
          // Emitir el resultado a todos los jugadores
          socket.emit('turnResolved', { room: roomId, outcome: outcome, nextTurn: currentPlayer });
        }
      }
    }
    
    /********** PANTALLA DE RESULTADO **********/
    function showResult(msg) {
      document.getElementById('result-message').textContent = msg;
      showView('result');
      setTimeout(() => { showView('main-menu'); }, 3500);
    }
    
    /********** OPCIONES DE COMBATE - Modo Local **********/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let opts = [];
      if (current.bullets > 0) opts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") opts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) opts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") opts.push("defender");
      if (current.character === "Amongolito") opts.push("sus");
      opts.forEach(op => {
        const btn = document.createElement('button');
        btn.textContent = op.charAt(0).toUpperCase() + op.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && op === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: op, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }
    
    /********** OPCIONES DE COMBATE - Modo Online **********/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let opts = [];
        if (current.bullets > 0) opts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") opts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) opts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") opts.push("defender");
        if (current.character === "Amongolito") opts.push("sus");
        opts.forEach(op => {
          const btn = document.createElement('button');
          btn.textContent = op.charAt(0).toUpperCase() + op.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && op === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                resolveTurnOnline();
                return;
              }
            }
            turnActions[playerIndex] = { action: op, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: op, bulletsSpent: 1, playerIndex });
            resolveTurnOnline();
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }
    
    /********** ENVÍO DE ACCIÓN - Modo Local **********/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }
    
    /********** BOT PARA LA IA (Modo VS IA) **********/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }
    
    /********** RESOLUCIÓN DE TURNOS (Local y Online) **********/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";
      
      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);
      
      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);
      
      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;
      
      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      // En modo online, el host (playerIndex 1) resuelve y emite el resultado
      if (gameMode === "online" && playerIndex === 1) {
        currentPlayer = (currentPlayer === 1) ? 2 : 1;
        socket.emit('turnResolved', { room: roomId, outcome: outcomeMsg, nextTurn: currentPlayer });
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online")
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        else
          currentPlayer = 1;
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          if (playerIndex === currentPlayer) {
            showCombatOptionsOnline();
          } else {
            document.getElementById('action-buttons').textContent = "Esperando acción del oponente...";
          }
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
      return outcomeMsg; // Para que el host pueda emitir el resultado
    }
    
    /********** RESOLUCIÓN DEL TURNO ONLINE (llamada tras recibir la acción del oponente) **********/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        if (playerIndex === 1) {
          resolveTurn();
        }
      }
    }
    
    /********** BOT PARA LA IA (Modo VS IA) **********/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }
    
    /********** PANTALLA DE RESULTADO **********/
    function showResult(msg) {
      document.getElementById('result-message').textContent = msg;
      showView('result');
      setTimeout(() => { showView('main-menu'); }, 3500);
    }
    
    /********** INICIAR COMBATE - Modo Local **********/
    function startCombatLocal() {
      gameOver = false;
      if (gameMode === "vs_ai") iaExperience++;
      player1 = createPlayer(player1Character);
      player2 = createPlayer(player2Character);
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    
    /********** INICIAR COMBATE - Modo Online **********/
    function startCombatOnline() {
      gameOver = false;
      player1 = createPlayer(player1Character, nickname);
      player2 = createPlayer(player2Character, opponentNickname);
      turnActions = { 1: null, 2: null };
      currentPlayer = playerIndex; // El turno inicial lo asigna el servidor
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptionsOnline();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    
    /********** ACTUALIZAR SCOREBOARD y TURNOS **********/
    function updateScoreboard() {
      document.getElementById('player1-name').textContent = player1.name;
      document.getElementById('player1-health').textContent = player1.health;
      document.getElementById('player1-bullets').textContent = player1.bullets;
      document.getElementById('player2-name').textContent = player2.name;
      document.getElementById('player2-health').textContent = player2.health;
      document.getElementById('player2-bullets').textContent = player2.bullets;
    }
    function updateCurrentTurnInfo() {
      const current = (currentPlayer === 1) ? player1 : player2;
      document.getElementById('turn-header').textContent = "TURNO DE " + current.name;
      document.getElementById('current-turn-img').src = characters[current.character].image;
      document.getElementById('current-turn-info').textContent = `Balas: ${current.bullets} | Health: ${current.health}`;
      if (current.character === "El Xokas") {
        updatePrediction();
      } else {
        document.getElementById('prediction').textContent = "";
      }
    }
    function updatePrediction() {
      const predictionEl = document.getElementById('prediction');
      const opponent = (currentPlayer === 1) ? player2 : player1;
      let allowed = [];
      if (opponent.bullets > 0) allowed.push("disparar");
      if (opponent.bullets < characters[opponent.character].initialBullets) allowed.push("recargar");
      if (opponent.lastAction !== "defender") allowed.push("defender");
      predictionEl.textContent = allowed.length ? "El Xokas predice: " + allowed[Math.floor(Math.random() * allowed.length)] : "Sin acciones para predecir.";
    }
    
    /********** OPCIONES DE COMBATE - Modo Local **********/
    function showCombatOptions() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      const current = (currentPlayer === 1) ? player1 : player2;
      let opts = [];
      if (current.bullets > 0) opts.push("disparar");
      if (current.bullets > 0 && current.character !== "Amongolito") opts.push("suicidarse");
      if (current.bullets < characters[current.character].initialBullets) opts.push("recargar");
      if (current.lastAction !== "defender" && current.character !== "Manueh") opts.push("defender");
      if (current.character === "Amongolito") opts.push("sus");
      opts.forEach(op => {
        const btn = document.createElement('button');
        btn.textContent = op.charAt(0).toUpperCase() + op.slice(1);
        btn.addEventListener('click', () => {
          if (turnActions[currentPlayer] !== null) return;
          if (current.character === "Kurt Cobain" && op === "disparar") {
            current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
            if (Math.random() < current.currentSuicideChance) {
              submitAction({ action: "suicidarse", bulletsSpent: 1 });
              return;
            }
          }
          submitAction({ action: op, bulletsSpent: 1 });
        });
        container.appendChild(btn);
      });
    }
    
    /********** OPCIONES DE COMBATE - Modo Online **********/
    function showCombatOptionsOnline() {
      const container = document.getElementById('action-buttons');
      container.innerHTML = "";
      if ((playerIndex === 1 && currentPlayer === 1) || (playerIndex === 2 && currentPlayer === 2)) {
        const current = (currentPlayer === 1) ? player1 : player2;
        let opts = [];
        if (current.bullets > 0) opts.push("disparar");
        if (current.bullets > 0 && current.character !== "Amongolito") opts.push("suicidarse");
        if (current.bullets < characters[current.character].initialBullets) opts.push("recargar");
        if (current.lastAction !== "defender" && current.character !== "Manueh") opts.push("defender");
        if (current.character === "Amongolito") opts.push("sus");
        opts.forEach(op => {
          const btn = document.createElement('button');
          btn.textContent = op.charAt(0).toUpperCase() + op.slice(1);
          btn.addEventListener('click', () => {
            if (turnActions[playerIndex] !== null) return;
            if (current.character === "Kurt Cobain" && op === "disparar") {
              current.currentSuicideChance = Math.min(1, current.currentSuicideChance + 0.25);
              if (Math.random() < current.currentSuicideChance) {
                turnActions[playerIndex] = { action: "suicidarse", bulletsSpent: 1 };
                container.innerHTML = "Esperando acción del oponente...";
                socket.emit('playerAction', { room: roomId, nickname, action: "suicidarse", bulletsSpent: 1, playerIndex });
                resolveTurnOnline();
                return;
              }
            }
            turnActions[playerIndex] = { action: op, bulletsSpent: 1 };
            container.innerHTML = "Esperando acción del oponente...";
            socket.emit('playerAction', { room: roomId, nickname, action: op, bulletsSpent: 1, playerIndex });
            resolveTurnOnline();
          });
          container.appendChild(btn);
        });
      } else {
        container.textContent = "Esperando acción del oponente...";
      }
    }
    
    /********** ENVÍO DE ACCIÓN - Modo Local **********/
    function submitAction(actionObj) {
      turnActions[currentPlayer] = actionObj;
      if (gameMode === "duel") {
        if (currentPlayer === 1) {
          currentPlayer = 2;
          updateCurrentTurnInfo();
          showCombatOptions();
        } else {
          resolveTurn();
        }
      } else if (gameMode === "vs_ai") {
        botChooseAction();
      }
    }
    
    /********** BOT PARA LA IA (Modo VS IA) **********/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }
    
    /********** RESOLUCIÓN DE TURNOS (Local y Online) **********/
    function resolveTurn() {
      const a1 = turnActions[1].action;
      const a2 = turnActions[2].action;
      const b1 = turnActions[1].bulletsSpent;
      const b2 = turnActions[2].bulletsSpent;
      let outcomeMsg = "";
      
      if (["disparar", "suicidarse"].includes(a1))
        player1.bullets = Math.max(0, player1.bullets - b1);
      if (["disparar", "suicidarse"].includes(a2))
        player2.bullets = Math.max(0, player2.bullets - b2);
      
      outcomeMsg += handleSuicidesAndAmongolito(a1, a2);
      if (!gameOver) outcomeMsg += handleShotsAndRecargas(a1, a2);
      
      player1.lastAction = a1;
      player2.lastAction = a2;
      updateScoreboard();
      document.getElementById('combat-result').textContent = outcomeMsg;
      
      if (player1.health <= 0 || player2.health <= 0) {
        gameOver = true;
        outcomeMsg = handleDeath(outcomeMsg);
        document.getElementById('combat-result').textContent = outcomeMsg;
      }
      
      // En modo online, el host (playerIndex 1) resuelve y emite el resultado para que ambos clientes actualicen la UI
      if (gameMode === "online" && playerIndex === 1) {
        currentPlayer = (currentPlayer === 1) ? 2 : 1;
        socket.emit('turnResolved', { room: roomId, outcome: outcomeMsg, nextTurn: currentPlayer });
      }
      
      if (gameOver) {
        if (player1.character === "Kurt Cobain") player1.currentSuicideChance = 0.25;
        if (player2.character === "Kurt Cobain") player2.currentSuicideChance = 0.25;
        if (gameMode === "vs_ai") {
          iaExperience++;
          if (outcomeMsg.includes(player1.name)) botDefensiveBias++;
          else if (outcomeMsg.includes(player2.name)) botDefensiveBias = Math.max(botDefensiveBias - 1, 0);
        }
        setTimeout(() => { showResult(outcomeMsg); }, 3500);
      } else {
        turnActions = { 1: null, 2: null };
        if (gameMode === "online")
          currentPlayer = (currentPlayer === 1) ? 2 : 1;
        else
          currentPlayer = 1;
        player1.defenseActive = false;
        player2.defenseActive = false;
        updateCurrentTurnInfo();
        if (gameMode === "online") {
          if (playerIndex === currentPlayer) {
            showCombatOptionsOnline();
          } else {
            document.getElementById('action-buttons').textContent = "Esperando acción del oponente...";
          }
        } else {
          showCombatOptions();
        }
        setTimeout(() => { document.getElementById('combat-result').textContent = ""; }, 3500);
      }
      return outcomeMsg;
    }
    
    /********** RESOLUCIÓN DEL TURNO ONLINE **********/
    function resolveTurnOnline() {
      if (turnActions[1] && turnActions[2]) {
        if (playerIndex === 1) {
          resolveTurn();
        }
      }
    }
    
    /********** BOT PARA LA IA (Modo VS IA) **********/
    function botChooseAction() {
      if (turnActions[1].action === "disparar" &&
          player2.bullets > 0 &&
          player2.lastAction !== "defender") {
        let p = Math.min(1, botDefensiveBias / 10);
        if (Math.random() < p) {
          turnActions[2] = { action: "defender", bulletsSpent: 1 };
          resolveTurn();
          return;
        }
      }
      let possible = [];
      if (difficulty === "easy") {
        possible = ["disparar", "recargar", "defender", "suicidarse"];
      } else if (difficulty === "medium") {
        if (player2.bullets > 0) {
          const w = 2 + Math.floor(iaExperience / 5);
          for (let i = 0; i < w; i++) possible.push("disparar");
        }
        possible.push("recargar", "defender");
        if (Math.random() < 0.1) possible.push("suicidarse");
      } else if (difficulty === "hard") {
        if (player2.bullets > 0) {
          const w = 3 + Math.floor(iaExperience / 3);
          for (let i = 0; i < w; i++) possible.push("disparar");
        } else {
          possible.push("recargar", "recargar");
        }
        possible.push("defender");
        if (Math.random() < 0.05) possible.push("suicidarse");
      }
      const act = possible[Math.floor(Math.random() * possible.length)];
      turnActions[2] = { action: act, bulletsSpent: 1 };
      resolveTurn();
    }
    
    /********** ENVÍO DE ACCIÓN: (Modo Local se usa submitAction) **********/
    // (Ya se invoca en los listeners de botones)
    
    /********** PANTALLA DE RESULTADO **********/
    function showResult(msg) {
      document.getElementById('result-message').textContent = msg;
      showView('result');
      setTimeout(() => { showView('main-menu'); }, 3500);
    }
    
    /********** INICIAR COMBATE **********/
    // Modo local (VS IA y Duelo)
    function startCombatLocal() {
      gameOver = false;
      if (gameMode === "vs_ai") iaExperience++;
      player1 = createPlayer(player1Character);
      player2 = createPlayer(player2Character);
      turnActions = { 1: null, 2: null };
      currentPlayer = 1;
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptions();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    // Modo online
    function startCombatOnline() {
      gameOver = false;
      player1 = createPlayer(player1Character, nickname);
      player2 = createPlayer(player2Character, opponentNickname);
      turnActions = { 1: null, 2: null };
      currentPlayer = playerIndex; // El turno inicial lo asigna el servidor
      updateScoreboard();
      updateCurrentTurnInfo();
      updateBackgroundMusic("combat");
      showCombatOptionsOnline();
      showView('combat');
      document.getElementById('combat-result').textContent = "";
    }
    
    /********** CONTROL DE VOLUMEN **********/
    document.getElementById('volume-slider').addEventListener('input', function() {
      bgMusic.volume = parseFloat(this.value);
    });
  </script>
  <script>
    // Si no existe el slider, créalo dinámicamente
    if (!document.getElementById('volume-slider')) {
      const vc = document.createElement('div');
      vc.id = "volume-control";
      vc.innerHTML = `<label for="volume-slider">Volumen:</label>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">`;
      document.getElementById('main-menu').appendChild(vc);
    }
  </script>
</body>
</html>
